{% extends 'layouts/base.html' %}
{% block title %} Machine Learning {% endblock title %}

{% block stylesheets %}
<style>
  .model-card { transition: all 0.3s ease; border-left: 4px solid #5e72e4; }
  .model-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  .model-card.active { border-left-color: #2dce89; }
  .model-card.training { border-left-color: #ffd600; }
  .confidence-bar { height: 6px; border-radius: 3px; background: #e9ecef; overflow: hidden; }
  .implication-box { background: linear-gradient(to right, rgba(94,114,228,0.05), rgba(130,94,228,0.05)); border-radius: 8px; padding: 12px; margin-top: 8px; }
  .status-pulse { animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-gradient-primary">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-auto">
              <div class="icon icon-shape bg-white shadow text-center border-radius-md p-3">
                <i class="fas fa-brain text-primary fa-2x"></i>
              </div>
            </div>
            <div class="col">
              <h4 class="text-white mb-1">Machine Learning Models</h4>
              <p class="text-white opacity-8 mb-0">AI-powered trading enhancements including regime detection, risk prediction, and signal validation.</p>
            </div>
            <div class="col-auto">
              <span class="badge bg-white text-primary px-3 py-2"><i class="fas fa-check-circle me-1"></i>3 Models Active</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ML Models Overview -->
  <div class="row mb-4">
    <!-- Market Regime Detector -->
    <div class="col-lg-4 mb-4">
      <div class="card model-card active h-100">
        <div class="card-header pb-0 d-flex justify-content-between">
          <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Market Regime Detector</h6>
          <span class="badge bg-success">Active</span>
        </div>
        <div class="card-body">
          <p class="text-sm text-secondary">Classifies market conditions to adapt strategy parameters.</p>

          <div class="mb-3">
            <label class="text-xs text-uppercase text-secondary">Current Regime</label>
            <h4 class="mb-0 {% if ml.current_regime == 'bullish' %}text-success{% elif ml.current_regime == 'bearish' %}text-danger{% else %}text-warning{% endif %}"><i class="fas {% if ml.current_regime == 'bullish' %}fa-arrow-up{% elif ml.current_regime == 'bearish' %}fa-arrow-down{% else %}fa-arrows-alt-h{% endif %} me-2"></i>{{ ml.current_regime|title|default:"Bullish" }}</h4>
          </div>

          <div class="mb-3">
            <label class="text-xs text-uppercase text-secondary">Regime Probabilities</label>
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="text-sm">Bullish</span>
              <span class="text-sm font-weight-bold">{{ ml.regime_probabilities.bullish|default:"68" }}%</span>
            </div>
            <div class="confidence-bar mb-2">
              <div class="bg-success h-100" style="width: {{ ml.regime_probabilities.bullish|default:"68" }}%;"></div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="text-sm">Sideways</span>
              <span class="text-sm font-weight-bold">{{ ml.regime_probabilities.sideways|default:"24" }}%</span>
            </div>
            <div class="confidence-bar mb-2">
              <div class="bg-warning h-100" style="width: {{ ml.regime_probabilities.sideways|default:"24" }}%;"></div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="text-sm">Bearish</span>
              <span class="text-sm font-weight-bold">{{ ml.regime_probabilities.bearish|default:"8" }}%</span>
            </div>
            <div class="confidence-bar">
              <div class="bg-danger h-100" style="width: {{ ml.regime_probabilities.bearish|default:"8" }}%;"></div>
            </div>
          </div>

          <div class="implication-box">
            <small class="text-secondary"><i class="fas fa-lightbulb text-warning me-1"></i><strong>What this means:</strong> In bullish regime, position sizes increase by 20%, stop losses tighten. Your strategies automatically adapt to current market conditions.</small>
          </div>
        </div>
        <div class="card-footer pt-0">
          <small class="text-secondary">Last updated: 2 min ago</small>
        </div>
      </div>
    </div>

    <!-- Risk Prediction Model -->
    <div class="col-lg-4 mb-4">
      <div class="card model-card active h-100">
        <div class="card-header pb-0 d-flex justify-content-between">
          <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Risk Prediction (PPO)</h6>
          <span class="badge bg-success">Active</span>
        </div>
        <div class="card-body">
          <p class="text-sm text-secondary">Reinforcement learning agent for dynamic risk management.</p>

          <div class="mb-3">
            <label class="text-xs text-uppercase text-secondary">Current Recommendation</label>
            <h4 class="mb-0 text-info"><i class="fas fa-balance-scale me-2"></i>{% if ml.risk_recommendation == 'maintain_positions' %}Maintain Positions{% elif ml.risk_recommendation == 'reduce_exposure' %}Reduce Exposure{% elif ml.risk_recommendation == 'increase_exposure' %}Increase Exposure{% else %}{{ ml.risk_recommendation|default:"Maintain Positions" }}{% endif %}</h4>
          </div>

          <div class="mb-3">
            <label class="text-xs text-uppercase text-secondary">Risk Score</label>
            <div class="d-flex align-items-center">
              <h3 class="mb-0 {% if ml.risk_score <= 30 %}text-success{% elif ml.risk_score <= 60 %}text-warning{% else %}text-danger{% endif %}">{{ ml.risk_score|default:"32" }}</h3>
              <span class="text-sm text-secondary ms-2">/ 100 ({% if ml.risk_score <= 30 %}Low Risk{% elif ml.risk_score <= 60 %}Moderate Risk{% else %}High Risk{% endif %})</span>
            </div>
            <div class="progress mt-2" style="height: 10px;">
              <div class="progress-bar {% if ml.risk_score <= 30 %}bg-success{% elif ml.risk_score <= 60 %}bg-warning{% else %}bg-danger{% endif %}" style="width: {{ ml.risk_score|default:"32" }}%;"></div>
            </div>
          </div>

          <div class="mb-3">
            <label class="text-xs text-uppercase text-secondary">Model Performance</label>
            <div class="row">
              <div class="col-6">
                <span class="text-sm">Accuracy</span>
                <p class="font-weight-bold mb-0">78.5%</p>
              </div>
              <div class="col-6">
                <span class="text-sm">Sharpe Boost</span>
                <p class="font-weight-bold mb-0 text-success">+0.3</p>
              </div>
            </div>
          </div>

          <div class="implication-box">
            <small class="text-secondary"><i class="fas fa-robot text-primary me-1"></i><strong>How it works:</strong> PPO agent monitors portfolio Greeks, VaR, and drawdown to suggest position adjustments. Trained on 5 years of market data.</small>
          </div>
        </div>
        <div class="card-footer pt-0">
          <small class="text-secondary">Last updated: 5 min ago</small>
        </div>
      </div>
    </div>

    <!-- Signal Validator -->
    <div class="col-lg-4 mb-4">
      <div class="card model-card active h-100">
        <div class="card-header pb-0 d-flex justify-content-between">
          <h6 class="mb-0"><i class="fas fa-check-double me-2"></i>Signal Validator</h6>
          <span class="badge bg-success">Active</span>
        </div>
        <div class="card-body">
          <p class="text-sm text-secondary">Validates trading signals before execution with multi-factor scoring.</p>

          <div class="mb-3">
            <label class="text-xs text-uppercase text-secondary">Today's Signals</label>
            <div class="row">
              <div class="col-4 text-center">
                <h4 class="mb-0">{{ ml.signals_generated|default:"12" }}</h4>
                <small class="text-secondary">Generated</small>
              </div>
              <div class="col-4 text-center">
                <h4 class="mb-0 text-success">{{ ml.signals_approved|default:"8" }}</h4>
                <small class="text-secondary">Approved</small>
              </div>
              <div class="col-4 text-center">
                <h4 class="mb-0 text-danger">{{ ml.signals_rejected|default:"4" }}</h4>
                <small class="text-secondary">Rejected</small>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="text-xs text-uppercase text-secondary">Validation Factors</label>
            <ul class="list-unstyled mb-0">
              <li class="d-flex justify-content-between text-sm py-1">
                <span>Technical Confluence</span>
                <span class="{% if ml.validation_factors.technical_confluence >= 60 %}text-success{% else %}text-warning{% endif %}"><i class="fas {% if ml.validation_factors.technical_confluence >= 60 %}fa-check{% else %}fa-exclamation{% endif %}"></i> {{ ml.validation_factors.technical_confluence|default:"85" }}%</span>
              </li>
              <li class="d-flex justify-content-between text-sm py-1">
                <span>Volume Confirmation</span>
                <span class="{% if ml.validation_factors.volume_confirmation >= 60 %}text-success{% else %}text-warning{% endif %}"><i class="fas {% if ml.validation_factors.volume_confirmation >= 60 %}fa-check{% else %}fa-exclamation{% endif %}"></i> {{ ml.validation_factors.volume_confirmation|default:"72" }}%</span>
              </li>
              <li class="d-flex justify-content-between text-sm py-1">
                <span>Options Flow</span>
                <span class="{% if ml.validation_factors.options_flow >= 60 %}text-success{% else %}text-warning{% endif %}"><i class="fas {% if ml.validation_factors.options_flow >= 60 %}fa-check{% else %}fa-exclamation{% endif %}"></i> {{ ml.validation_factors.options_flow|default:"58" }}%</span>
              </li>
              <li class="d-flex justify-content-between text-sm py-1">
                <span>Historical Pattern</span>
                <span class="{% if ml.validation_factors.historical_pattern >= 60 %}text-success{% else %}text-warning{% endif %}"><i class="fas {% if ml.validation_factors.historical_pattern >= 60 %}fa-check{% else %}fa-exclamation{% endif %}"></i> {{ ml.validation_factors.historical_pattern|default:"67" }}%</span>
              </li>
            </ul>
          </div>

          <div class="implication-box">
            <small class="text-secondary"><i class="fas fa-filter text-info me-1"></i><strong>Why this matters:</strong> Signals with score <60 are rejected, preventing low-probability trades. This has improved win rate by 12% historically.</small>
          </div>
        </div>
        <div class="card-footer pt-0">
          <small class="text-secondary">Last updated: 1 min ago</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Model Training & Settings -->
  <div class="row">
    <!-- Training Status -->
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6><i class="fas fa-cogs me-2"></i>Model Training</h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Model</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Last Trained</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Accuracy</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center">Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><span class="font-weight-bold">Regime Detector</span></td>
                  <td class="text-center text-sm">2 days ago</td>
                  <td class="text-center text-sm">82.3%</td>
                  <td class="text-center"><span class="badge bg-success">Ready</span></td>
                </tr>
                <tr>
                  <td><span class="font-weight-bold">PPO Risk Agent</span></td>
                  <td class="text-center text-sm">1 week ago</td>
                  <td class="text-center text-sm">78.5%</td>
                  <td class="text-center"><span class="badge bg-success">Ready</span></td>
                </tr>
                <tr>
                  <td><span class="font-weight-bold">Signal Validator</span></td>
                  <td class="text-center text-sm">3 days ago</td>
                  <td class="text-center text-sm">74.1%</td>
                  <td class="text-center"><span class="badge bg-success">Ready</span></td>
                </tr>
                <tr>
                  <td><span class="font-weight-bold">DDPG Optimizer</span></td>
                  <td class="text-center text-sm">-</td>
                  <td class="text-center text-sm">-</td>
                  <td class="text-center"><span class="badge bg-secondary">Not Trained</span></td>
                </tr>
              </tbody>
            </table>
          </div>

          <hr>

          <div class="d-flex justify-content-between">
            <button class="btn btn-outline-primary mb-0">
              <i class="fas fa-sync me-2"></i>Retrain All Models
            </button>
            <button class="btn btn-outline-info mb-0">
              <i class="fas fa-download me-2"></i>Export Models
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ML Settings -->
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6><i class="fas fa-sliders-h me-2"></i>ML Configuration</h6>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <label class="form-label d-flex justify-content-between">
              <span>Minimum Signal Confidence</span>
              <span class="badge bg-primary" id="minConfidenceValue">{{ ml.min_confidence_threshold|default:"60" }}%</span>
            </label>
            <input type="range" class="form-range" min="40" max="90" value="{{ ml.min_confidence_threshold|default:"60" }}" id="minConfidence">
            <div class="implication-box">
              <small class="text-secondary"><i class="fas fa-filter text-info me-1"></i><strong>60% threshold:</strong> Signals below this score are automatically rejected. Higher = fewer but higher-quality trades. Lower = more trades but lower win rate.</small>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label d-flex justify-content-between">
              <span>Regime Sensitivity</span>
              <span class="badge bg-warning" id="regimeSensitivityValue">Medium</span>
            </label>
            <input type="range" class="form-range" min="1" max="3" value="2" id="regimeSensitivity">
            <div class="implication-box">
              <small class="text-secondary"><i class="fas fa-tachometer-alt text-warning me-1"></i><strong>Medium sensitivity:</strong> Regime changes trigger moderate strategy adjustments. High = aggressive adaptation. Low = more stable but slower to react.</small>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label">Auto-Retrain Schedule</label>
            <select class="form-select" id="retrainSchedule">
              <option value="never">Manual Only</option>
              <option value="weekly" selected>Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="quarterly">Quarterly</option>
            </select>
          </div>

          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="enableMLRisk" checked>
            <label class="form-check-label" for="enableMLRisk">
              <strong>Enable ML Risk Adjustments</strong>
              <br><small class="text-secondary">Allow PPO agent to adjust position sizes</small>
            </label>
          </div>

          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="enableSignalGate" checked>
            <label class="form-check-label" for="enableSignalGate">
              <strong>Enable Signal Validation Gate</strong>
              <br><small class="text-secondary">Require ML approval before trade execution</small>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info Box -->
  <div class="row">
    <div class="col-12">
      <div class="card" style="background: linear-gradient(to right, rgba(94,114,228,0.1), rgba(130,94,228,0.1)); border: 2px solid #5e72e4;">
        <div class="card-body text-center py-4">
          <i class="fas fa-graduation-cap fa-3x text-primary mb-3"></i>
          <h5>Machine Learning in Trading</h5>
          <p class="text-secondary mb-0">These ML models are designed to <strong>enhance, not replace</strong> your trading rules. They adapt parameters based on market conditions, validate signals before execution, and manage risk dynamically. All models are trained on historical data and continuously learn from your trading performance.</p>
        </div>
      </div>
    </div>
  </div>

  {% include "includes/footer.html" %}
</div>
{% endblock content %}

{% block javascripts %}
<script>
  document.getElementById('minConfidence').addEventListener('input', function() {
    document.getElementById('minConfidenceValue').textContent = this.value + '%';
  });

  document.getElementById('regimeSensitivity').addEventListener('input', function() {
    const labels = ['Low', 'Medium', 'High'];
    document.getElementById('regimeSensitivityValue').textContent = labels[this.value - 1];
  });
</script>
{% endblock javascripts %}
