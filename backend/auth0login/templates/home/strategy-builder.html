{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Strategy Builder{% endblock %}

{% block stylesheets %}
{{ block.super }}
<style>
    /* Drag-Drop Styles */
    .indicator-palette {
        max-height: 400px;
        overflow-y: auto;
    }
    .indicator-item {
        padding: 8px 12px;
        margin-bottom: 6px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 6px;
        cursor: grab;
        font-size: 0.85rem;
        transition: all 0.2s ease;
    }
    .indicator-item:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        transform: translateX(3px);
    }
    .indicator-item:active {
        cursor: grabbing;
    }
    .indicator-item.sortable-ghost {
        opacity: 0.4;
    }
    .indicator-item .badge {
        font-size: 0.65rem;
    }

    /* Condition Group Styles */
    .condition-group {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        min-height: 60px;
        background: #fafbfc;
        transition: all 0.2s ease;
    }
    .condition-group.sortable-ghost {
        opacity: 0.4;
    }
    .condition-group.group-dragover {
        border-color: #0d6efd;
        background: #e7f1ff;
    }
    .condition-group.group-and {
        border-color: #198754;
        background: rgba(25, 135, 84, 0.05);
    }
    .condition-group.group-or {
        border-color: #fd7e14;
        background: rgba(253, 126, 20, 0.05);
    }
    .condition-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .condition-group-content {
        min-height: 40px;
    }
    .condition-group .empty-placeholder {
        text-align: center;
        padding: 15px;
        color: #6c757d;
        font-size: 0.85rem;
    }

    /* Condition Block Styles */
    .condition-block {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 10px 12px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: grab;
        transition: all 0.2s ease;
    }
    .condition-block:hover {
        border-color: #0d6efd;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .condition-block.sortable-ghost {
        opacity: 0.4;
    }
    .condition-block .form-select-sm,
    .condition-block .form-control-sm {
        font-size: 0.8rem;
    }
    .condition-block .remove-btn {
        opacity: 0.5;
        cursor: pointer;
        transition: opacity 0.2s;
    }
    .condition-block:hover .remove-btn {
        opacity: 1;
    }

    /* Logic Badge */
    .logic-badge {
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.75rem;
    }
    .logic-badge.and {
        background: #d1e7dd;
        color: #0f5132;
    }
    .logic-badge.or {
        background: #fff3cd;
        color: #664d03;
    }

    /* Condition Tree Visualization */
    .condition-tree {
        font-family: monospace;
        font-size: 0.85rem;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        white-space: pre-wrap;
        line-height: 1.6;
    }
    .condition-tree .keyword {
        color: #0d6efd;
        font-weight: 600;
    }
    .condition-tree .operator {
        color: #dc3545;
    }
    .condition-tree .value {
        color: #198754;
    }
    .condition-tree .group-and {
        color: #0f5132;
    }
    .condition-tree .group-or {
        color: #664d03;
    }

    /* Palette Category */
    .palette-category {
        margin-bottom: 15px;
    }
    .palette-category-header {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #6c757d;
        font-weight: 600;
        margin-bottom: 8px;
        padding-bottom: 4px;
        border-bottom: 1px solid #e9ecef;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <h2 class="text-white mb-1">Strategy Builder</h2>
                            <p class="text-white opacity-8 mb-0">
                                Drag and drop indicators to build custom trading strategies with nested conditions
                            </p>
                        </div>
                        <div class="col-lg-4 text-lg-end">
                            <button class="btn btn-white btn-sm me-2" onclick="showTemplates()">
                                <i class="fas fa-copy me-1"></i> Start from Template
                            </button>
                            <button class="btn btn-outline-white btn-sm" onclick="showIndicatorReference()">
                                <i class="fas fa-book me-1"></i> Indicator Reference
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy List (when not editing) -->
    <div class="row mb-4" id="strategyListSection">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <div class="row align-items-center">
                        <div class="col-lg-6">
                            <h5 class="mb-0">My Custom Strategies</h5>
                        </div>
                        <div class="col-lg-6 text-end">
                            <button class="btn btn-primary btn-sm" onclick="createNewStrategy()">
                                <i class="fas fa-plus me-1"></i> New Strategy
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body px-0 pt-0 pb-2">
                    <div class="table-responsive p-0" id="strategyListContainer">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy Builder (when editing) -->
    <div class="row" id="builderSection" style="display: none;">
        <!-- Builder Header -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-body py-3">
                    <div class="row align-items-center">
                        <div class="col-lg-4">
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="cancelEdit()">
                                <i class="fas fa-arrow-left me-1"></i> Back
                            </button>
                            <span class="text-lg font-weight-bold" id="strategyNameDisplay">New Strategy</span>
                        </div>
                        <div class="col-lg-4">
                            <input type="text" class="form-control" id="strategyName" placeholder="Strategy Name" value="">
                        </div>
                        <div class="col-lg-4 text-end">
                            <button class="btn btn-outline-info btn-sm me-2" onclick="validateStrategy()">
                                <i class="fas fa-check-circle me-1"></i> Validate
                            </button>
                            <button class="btn btn-info btn-sm me-2" onclick="runBacktest()">
                                <i class="fas fa-chart-line me-1"></i> Backtest
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="saveStrategy()">
                                <i class="fas fa-save me-1"></i> Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Indicator Palette (Sidebar) -->
        <div class="col-lg-3 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6 class="mb-0"><i class="fas fa-palette text-primary me-2"></i>Indicator Palette</h6>
                    <p class="text-xs text-muted mb-0">Drag indicators to entry/exit areas</p>
                </div>
                <div class="card-body indicator-palette" id="indicatorPalette">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Builder Main Area -->
        <div class="col-lg-9">
            <div class="row">
                <!-- Entry Conditions -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0"><i class="fas fa-sign-in-alt text-success me-2"></i>Entry Conditions</h6>
                                <p class="text-xs text-muted mb-0">When to BUY - drag conditions here</p>
                            </div>
                            <button class="btn btn-outline-success btn-sm" onclick="addConditionGroup('entry')">
                                <i class="fas fa-layer-group me-1"></i> Add Group
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="entryConditionsContainer" class="condition-group group-and">
                                <div class="condition-group-header">
                                    <span class="logic-badge and">ALL (AND)</span>
                                    <div>
                                        <button class="btn btn-xs btn-outline-secondary" onclick="toggleGroupLogic('entry-root')">
                                            <i class="fas fa-exchange-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="condition-group-content" id="entry-root" data-group-id="root" data-logic="AND">
                                    <div class="empty-placeholder">
                                        <i class="fas fa-hand-pointer me-1"></i>
                                        Drag indicators here or click "Add Group" for complex conditions
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exit Conditions -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0"><i class="fas fa-sign-out-alt text-danger me-2"></i>Exit Conditions</h6>
                                <p class="text-xs text-muted mb-0">When to SELL - any condition triggers exit</p>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="addConditionGroup('exit')">
                                <i class="fas fa-layer-group me-1"></i> Add Group
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="exitConditionsContainer" class="condition-group group-or">
                                <div class="condition-group-header">
                                    <span class="logic-badge or">ANY (OR)</span>
                                    <div>
                                        <button class="btn btn-xs btn-outline-secondary" onclick="toggleGroupLogic('exit-root')">
                                            <i class="fas fa-exchange-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="condition-group-content" id="exit-root" data-group-id="root" data-logic="OR">
                                    <div class="empty-placeholder">
                                        <i class="fas fa-hand-pointer me-1"></i>
                                        Drag exit types here (Stop Loss, Take Profit, etc.)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Position Sizing & Filters -->
            <div class="row">
                <div class="col-md-6 mb-4">
                    <!-- Position Sizing -->
                    <div class="card">
                        <div class="card-header pb-0">
                            <h6 class="mb-0"><i class="fas fa-balance-scale text-info me-2"></i>Position Sizing</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-xs text-uppercase">Size Type</label>
                                    <select class="form-select form-select-sm" id="sizingType">
                                        <option value="fixed_percent">Fixed Percentage</option>
                                        <option value="fixed_dollar">Fixed Dollar</option>
                                        <option value="equal_weight">Equal Weight</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-xs text-uppercase">Size Value</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control" id="sizingValue" value="5" min="1" max="100">
                                        <span class="input-group-text" id="sizingUnit">%</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label text-xs text-uppercase">Max Concurrent Positions</label>
                                    <input type="number" class="form-control form-control-sm" id="maxPositions" value="5" min="1" max="20">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <!-- Filters -->
                    <div class="card">
                        <div class="card-header pb-0">
                            <h6 class="mb-0"><i class="fas fa-filter text-warning me-2"></i>Stock Filters</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-xs text-uppercase">Min Price ($)</label>
                                    <input type="number" class="form-control form-control-sm" id="filterMinPrice" value="10" min="0">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-xs text-uppercase">Stock Universe</label>
                                    <select class="form-select form-select-sm" id="universe">
                                        <option value="sp500">S&P 500</option>
                                        <option value="nasdaq100">Nasdaq 100</option>
                                        <option value="dow30">Dow 30</option>
                                        <option value="russell2000">Russell 2000</option>
                                        <option value="custom">Custom List</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-xs text-uppercase">Min Volume</label>
                                    <input type="number" class="form-control form-control-sm" id="filterMinVolume" value="500000" min="0" step="100000">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="filterSkipEarnings" checked>
                                        <label class="form-check-label text-sm" for="filterSkipEarnings">
                                            Skip earnings week
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div id="customSymbolsContainer" style="display: none;">
                                <label class="form-label text-xs text-uppercase">Custom Symbols</label>
                                <input type="text" class="form-control form-control-sm" id="customSymbols" placeholder="AAPL, MSFT, GOOGL...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Preview -->
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header pb-0">
                            <h6 class="mb-0"><i class="fas fa-eye text-primary me-2"></i>Strategy Preview</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-7">
                                    <h6 class="text-xs text-uppercase text-muted mb-2">Condition Tree</h6>
                                    <div class="condition-tree" id="conditionTreePreview">
                                        <span class="keyword">BUY</span> when (no conditions defined)
                                        <span class="keyword">SELL</span> when (no conditions defined)
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <h6 class="text-xs text-uppercase text-muted mb-2">Validation Status</h6>
                                    <div id="validationStatus">
                                        <span class="badge bg-secondary">Not validated</span>
                                    </div>
                                    <div id="validationMessages" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backtest Results -->
            <div class="row" id="backtestResultsSection" style="display: none;">
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header pb-0">
                            <h6 class="mb-0"><i class="fas fa-chart-bar text-success me-2"></i>Backtest Results</h6>
                        </div>
                        <div class="card-body" id="backtestResultsContent">
                            <!-- Results populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Templates Modal -->
<div class="modal fade" id="templatesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Strategy Templates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="templatesContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Indicator Reference Modal -->
<div class="modal fade" id="indicatorModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Indicator Reference</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="indicatorContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ block.super }}
<!-- SortableJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    // Global state
    let currentStrategyId = null;
    let indicators = [];
    let operators = [];
    let exitTypes = [];
    let entryConditionTree = { type: 'group', logic: 'AND', conditions: [] };
    let exitConditionTree = { type: 'group', logic: 'OR', conditions: [] };
    let conditionIdCounter = 0;
    let sortableInstances = [];

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStrategies();
        loadBuilderOptions();

        // Universe change handler
        document.getElementById('universe').addEventListener('change', function() {
            document.getElementById('customSymbolsContainer').style.display =
                this.value === 'custom' ? 'block' : 'none';
        });

        // Sizing type change handler
        document.getElementById('sizingType').addEventListener('change', function() {
            document.getElementById('sizingUnit').textContent =
                this.value === 'fixed_dollar' ? '$' : '%';
        });
    });

    async function loadStrategies() {
        try {
            const response = await fetch('/api/custom-strategies/');
            const data = await response.json();
            renderStrategyList(data.strategies || []);
        } catch (error) {
            console.error('Error loading strategies:', error);
        }
    }

    async function loadBuilderOptions() {
        try {
            const response = await fetch('/api/custom-strategies/indicators/');
            const data = await response.json();

            indicators = data.indicators || [];
            operators = data.operators || [];
            exitTypes = data.exit_types || [];

            renderIndicatorPalette();
        } catch (error) {
            console.error('Error loading builder options:', error);
        }
    }

    function renderIndicatorPalette() {
        const container = document.getElementById('indicatorPalette');

        // Group indicators by category
        const categories = {
            momentum: { name: 'Momentum', items: [] },
            trend: { name: 'Trend', items: [] },
            volatility: { name: 'Volatility', items: [] },
            volume: { name: 'Volume', items: [] },
            price: { name: 'Price', items: [] },
            exits: { name: 'Exit Types', items: [] }
        };

        // Categorize indicators
        indicators.forEach(ind => {
            const cat = ind.category || 'momentum';
            if (categories[cat]) {
                categories[cat].items.push(ind);
            } else {
                categories.momentum.items.push(ind);
            }
        });

        // Add exit types
        exitTypes.forEach(exit => {
            categories.exits.items.push({
                id: exit.id,
                name: exit.name,
                description: exit.description,
                isExit: true
            });
        });

        let html = '';
        for (const [key, cat] of Object.entries(categories)) {
            if (cat.items.length === 0) continue;

            html += `
                <div class="palette-category">
                    <div class="palette-category-header">${cat.name}</div>
                    <div class="indicator-list" id="palette-${key}">
                        ${cat.items.map(item => `
                            <div class="indicator-item" draggable="true"
                                 data-indicator-id="${item.id}"
                                 data-indicator-name="${item.name}"
                                 data-is-exit="${item.isExit || false}">
                                <i class="fas fa-grip-vertical text-muted me-2"></i>
                                ${item.name}
                                ${item.default_period ? `<span class="badge bg-light text-muted float-end">${item.default_period}</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;

        // Initialize drag from palette
        document.querySelectorAll('.indicator-item').forEach(item => {
            item.addEventListener('dragstart', handleIndicatorDragStart);
        });
    }

    function handleIndicatorDragStart(e) {
        e.dataTransfer.setData('application/json', JSON.stringify({
            indicatorId: e.target.dataset.indicatorId,
            indicatorName: e.target.dataset.indicatorName,
            isExit: e.target.dataset.isExit === 'true'
        }));
        e.dataTransfer.effectAllowed = 'copy';
    }

    function initializeSortables() {
        // Clean up existing instances
        sortableInstances.forEach(s => s.destroy());
        sortableInstances = [];

        // Initialize sortables for entry conditions
        initializeSortableGroup('entry-root', 'entry');

        // Initialize sortables for exit conditions
        initializeSortableGroup('exit-root', 'exit');
    }

    function initializeSortableGroup(containerId, type) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const sortable = new Sortable(container, {
            group: {
                name: type + '-conditions',
                pull: true,
                put: true
            },
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            handle: '.condition-block, .condition-group',
            onAdd: function(evt) {
                updatePreview();
            },
            onEnd: function(evt) {
                updatePreview();
            }
        });
        sortableInstances.push(sortable);

        // Allow dropping from palette
        container.addEventListener('dragover', (e) => {
            e.preventDefault();
            container.parentElement.classList.add('group-dragover');
        });

        container.addEventListener('dragleave', (e) => {
            container.parentElement.classList.remove('group-dragover');
        });

        container.addEventListener('drop', (e) => {
            e.preventDefault();
            container.parentElement.classList.remove('group-dragover');

            try {
                const data = JSON.parse(e.dataTransfer.getData('application/json'));
                if (data.indicatorId) {
                    addConditionFromPalette(containerId, data, type);
                }
            } catch (err) {
                console.log('Not a palette drop');
            }
        });
    }

    function addConditionFromPalette(containerId, data, type) {
        const container = document.getElementById(containerId);

        // Remove placeholder if present
        const placeholder = container.querySelector('.empty-placeholder');
        if (placeholder) placeholder.remove();

        const condId = `cond-${++conditionIdCounter}`;

        if (data.isExit) {
            // Exit condition (stop loss, take profit, etc.)
            const exitType = exitTypes.find(e => e.id === data.indicatorId);
            const defaultValue = data.indicatorId === 'stop_loss' ? 5 :
                                data.indicatorId === 'take_profit' ? 10 :
                                data.indicatorId === 'trailing_stop' ? 7 : 5;

            const html = `
                <div class="condition-block exit-condition" id="${condId}" data-type="${data.indicatorId}">
                    <i class="fas fa-grip-vertical text-muted"></i>
                    <span class="text-sm font-weight-bold">${data.indicatorName}</span>
                    ${data.indicatorId === 'time_based' ? `
                        <input type="number" class="form-control form-control-sm" style="width: 60px;"
                               value="5" min="1" onchange="updatePreview()">
                        <span class="text-sm">days</span>
                    ` : data.indicatorId === 'indicator' ? `
                        <select class="form-select form-select-sm" style="width: 100px;" onchange="updatePreview()">
                            ${indicators.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}
                        </select>
                        <select class="form-select form-select-sm" style="width: 60px;" onchange="updatePreview()">
                            ${operators.map(o => `<option value="${o.id}">${o.symbol}</option>`).join('')}
                        </select>
                        <input type="number" class="form-control form-control-sm" style="width: 60px;"
                               value="70" onchange="updatePreview()">
                    ` : `
                        <input type="number" class="form-control form-control-sm" style="width: 60px;"
                               value="${defaultValue}" min="0" step="0.5" onchange="updatePreview()">
                        <span class="text-sm">%</span>
                    `}
                    <i class="fas fa-times text-danger remove-btn ms-auto" onclick="removeCondition('${condId}')"></i>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        } else {
            // Entry condition (indicator-based)
            const indicator = indicators.find(i => i.id === data.indicatorId);
            const defaultPeriod = indicator?.default_period || 14;
            const defaultValue = indicator?.typical_buy || 30;

            const html = `
                <div class="condition-block entry-condition" id="${condId}" data-indicator="${data.indicatorId}">
                    <i class="fas fa-grip-vertical text-muted"></i>
                    <select class="form-select form-select-sm" style="width: 90px;" onchange="updatePreview()">
                        ${indicators.map(i => `<option value="${i.id}" ${i.id === data.indicatorId ? 'selected' : ''}>${i.name}</option>`).join('')}
                    </select>
                    <input type="number" class="form-control form-control-sm" style="width: 50px;"
                           value="${defaultPeriod}" min="1" title="Period" onchange="updatePreview()">
                    <select class="form-select form-select-sm" style="width: 60px;" onchange="updatePreview()">
                        ${operators.map(o => `<option value="${o.id}">${o.symbol}</option>`).join('')}
                    </select>
                    <input type="number" class="form-control form-control-sm" style="width: 60px;"
                           value="${defaultValue}" step="0.1" onchange="updatePreview()">
                    <i class="fas fa-times text-danger remove-btn ms-auto" onclick="removeCondition('${condId}')"></i>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        updatePreview();
    }

    function addConditionGroup(type) {
        const containerId = type === 'entry' ? 'entry-root' : 'exit-root';
        const container = document.getElementById(containerId);

        // Remove placeholder if present
        const placeholder = container.querySelector('.empty-placeholder');
        if (placeholder) placeholder.remove();

        const groupId = `group-${++conditionIdCounter}`;
        const defaultLogic = type === 'entry' ? 'OR' : 'AND'; // Opposite of parent for variety

        const html = `
            <div class="condition-group group-${defaultLogic.toLowerCase()}" id="${groupId}-wrapper">
                <div class="condition-group-header">
                    <span class="logic-badge ${defaultLogic.toLowerCase()}">${defaultLogic === 'AND' ? 'ALL (AND)' : 'ANY (OR)'}</span>
                    <div>
                        <button class="btn btn-xs btn-outline-secondary me-1" onclick="toggleGroupLogic('${groupId}')">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="btn btn-xs btn-outline-danger" onclick="removeGroup('${groupId}-wrapper')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="condition-group-content" id="${groupId}" data-group-id="${groupId}" data-logic="${defaultLogic}">
                    <div class="empty-placeholder">
                        <i class="fas fa-hand-pointer me-1"></i>
                        Drag conditions here
                    </div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', html);

        // Initialize sortable for the new group
        initializeSortableGroup(groupId, type);
        updatePreview();
    }

    function toggleGroupLogic(groupId) {
        const container = document.getElementById(groupId);
        const wrapper = container.parentElement;
        const badge = wrapper.querySelector('.logic-badge');

        const currentLogic = container.dataset.logic;
        const newLogic = currentLogic === 'AND' ? 'OR' : 'AND';

        container.dataset.logic = newLogic;
        badge.textContent = newLogic === 'AND' ? 'ALL (AND)' : 'ANY (OR)';
        badge.className = `logic-badge ${newLogic.toLowerCase()}`;
        wrapper.className = `condition-group group-${newLogic.toLowerCase()}`;

        updatePreview();
    }

    function removeCondition(condId) {
        const element = document.getElementById(condId);
        if (element) {
            element.remove();
            updatePreview();
        }
    }

    function removeGroup(groupId) {
        const element = document.getElementById(groupId);
        if (element) {
            element.remove();
            updatePreview();
        }
    }

    function getConditionsFromContainer(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return null;

        const logic = container.dataset.logic || 'AND';
        const conditions = [];

        // Get direct children conditions
        container.querySelectorAll(':scope > .condition-block').forEach(block => {
            const cond = parseConditionBlock(block);
            if (cond) conditions.push(cond);
        });

        // Get nested groups
        container.querySelectorAll(':scope > .condition-group').forEach(group => {
            const nestedContainer = group.querySelector('.condition-group-content');
            if (nestedContainer) {
                const nested = getConditionsFromContainer(nestedContainer.id);
                if (nested && nested.conditions.length > 0) {
                    conditions.push(nested);
                }
            }
        });

        return {
            type: 'group',
            logic: logic,
            conditions: conditions
        };
    }

    function parseConditionBlock(block) {
        if (block.classList.contains('entry-condition')) {
            const selects = block.querySelectorAll('select');
            const inputs = block.querySelectorAll('input[type="number"]');

            return {
                type: 'condition',
                indicator: selects[0]?.value || 'rsi',
                period: parseInt(inputs[0]?.value) || 14,
                operator: selects[1]?.value || 'less_than',
                value: parseFloat(inputs[1]?.value) || 30
            };
        } else if (block.classList.contains('exit-condition')) {
            const exitType = block.dataset.type;
            const inputs = block.querySelectorAll('input[type="number"]');
            const selects = block.querySelectorAll('select');

            if (exitType === 'time_based') {
                return { type: 'time_based', days: parseInt(inputs[0]?.value) || 5 };
            } else if (exitType === 'indicator') {
                return {
                    type: 'indicator',
                    indicator: selects[0]?.value || 'rsi',
                    operator: selects[1]?.value || 'greater_than',
                    value: parseFloat(inputs[0]?.value) || 70
                };
            } else {
                return { type: exitType, value: parseFloat(inputs[0]?.value) || 5 };
            }
        }
        return null;
    }

    function updatePreview() {
        entryConditionTree = getConditionsFromContainer('entry-root') || { type: 'group', logic: 'AND', conditions: [] };
        exitConditionTree = getConditionsFromContainer('exit-root') || { type: 'group', logic: 'OR', conditions: [] };

        // Render condition tree
        const preview = document.getElementById('conditionTreePreview');
        let html = '<span class="keyword">BUY</span> when ';
        html += renderConditionTreeHTML(entryConditionTree);
        html += '\n\n<span class="keyword">SELL</span> when ';
        html += renderConditionTreeHTML(exitConditionTree);
        preview.innerHTML = html;
    }

    function renderConditionTreeHTML(node, indent = 0) {
        if (node.type === 'group') {
            if (node.conditions.length === 0) {
                return '<span class="text-muted">(no conditions)</span>';
            }

            const logicClass = node.logic === 'AND' ? 'group-and' : 'group-or';
            const logicText = node.logic === 'AND' ? 'AND' : 'OR';
            const padding = '  '.repeat(indent);

            if (node.conditions.length === 1) {
                return renderConditionTreeHTML(node.conditions[0], indent);
            }

            let html = '(\n';
            node.conditions.forEach((cond, idx) => {
                html += padding + '  ' + renderConditionTreeHTML(cond, indent + 1);
                if (idx < node.conditions.length - 1) {
                    html += `\n${padding}  <span class="${logicClass}">${logicText}</span>\n`;
                }
            });
            html += '\n' + padding + ')';
            return html;
        } else if (node.type === 'condition') {
            const ind = indicators.find(i => i.id === node.indicator);
            const op = operators.find(o => o.id === node.operator);
            return `<span class="keyword">${ind?.name || node.indicator}</span>` +
                   (node.period ? `(${node.period})` : '') +
                   ` <span class="operator">${op?.symbol || node.operator}</span>` +
                   ` <span class="value">${node.value}</span>`;
        } else {
            // Exit condition types
            if (node.type === 'stop_loss') return `Stop Loss at <span class="value">${node.value}%</span>`;
            if (node.type === 'take_profit') return `Take Profit at <span class="value">${node.value}%</span>`;
            if (node.type === 'trailing_stop') return `Trailing Stop <span class="value">${node.value}%</span>`;
            if (node.type === 'time_based') return `Hold max <span class="value">${node.days} days</span>`;
            if (node.type === 'indicator') {
                const ind = indicators.find(i => i.id === node.indicator);
                const op = operators.find(o => o.id === node.operator);
                return `<span class="keyword">${ind?.name || node.indicator}</span>` +
                       ` <span class="operator">${op?.symbol || node.operator}</span>` +
                       ` <span class="value">${node.value}</span>`;
            }
            return node.type;
        }
    }

    function renderStrategyList(strategies) {
        const container = document.getElementById('strategyListContainer');

        if (strategies.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-drafting-compass fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No custom strategies yet</p>
                    <button class="btn btn-primary btn-sm" onclick="createNewStrategy()">
                        <i class="fas fa-plus me-1"></i> Create Your First Strategy
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <table class="table align-items-center mb-0">
                <thead>
                    <tr>
                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-3">Strategy</th>
                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Conditions</th>
                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Last Backtest</th>
                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${strategies.map(s => `
                        <tr>
                            <td class="ps-3">
                                <div class="d-flex flex-column">
                                    <h6 class="mb-0 text-sm">${s.name}</h6>
                                    <p class="text-xs text-muted mb-0">${s.description || 'No description'}</p>
                                </div>
                            </td>
                            <td class="text-center">
                                ${s.is_active
                                    ? '<span class="badge bg-gradient-success">Active</span>'
                                    : s.is_validated
                                    ? '<span class="badge bg-gradient-info">Validated</span>'
                                    : '<span class="badge bg-gradient-secondary">Draft</span>'}
                            </td>
                            <td class="text-center">
                                <span class="text-sm">${s.entry_conditions_count} entry / ${s.exit_conditions_count} exit</span>
                            </td>
                            <td class="text-center">
                                ${s.backtest_summary && s.backtest_summary.has_backtest
                                    ? `<span class="text-${s.backtest_summary.total_return_pct >= 0 ? 'success' : 'danger'} text-sm">
                                        ${s.backtest_summary.total_return_pct >= 0 ? '+' : ''}${s.backtest_summary.total_return_pct.toFixed(1)}%
                                       </span>`
                                    : '<span class="text-muted text-sm">-</span>'}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-link text-info p-0 me-2" onclick="editStrategy(${s.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-link text-primary p-0 me-2" onclick="cloneStrategy(${s.id})" title="Clone">
                                    <i class="fas fa-copy"></i>
                                </button>
                                ${s.is_active
                                    ? `<button class="btn btn-link text-warning p-0 me-2" onclick="deactivateStrategy(${s.id})" title="Deactivate">
                                        <i class="fas fa-pause"></i>
                                       </button>`
                                    : s.is_validated
                                    ? `<button class="btn btn-link text-success p-0 me-2" onclick="activateStrategy(${s.id})" title="Activate">
                                        <i class="fas fa-play"></i>
                                       </button>`
                                    : ''}
                                <button class="btn btn-link text-danger p-0" onclick="deleteStrategy(${s.id}, '${s.name}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    function createNewStrategy() {
        currentStrategyId = null;
        conditionIdCounter = 0;
        entryConditionTree = { type: 'group', logic: 'AND', conditions: [] };
        exitConditionTree = { type: 'group', logic: 'OR', conditions: [] };

        document.getElementById('strategyName').value = '';
        document.getElementById('strategyNameDisplay').textContent = 'New Strategy';
        document.getElementById('sizingType').value = 'fixed_percent';
        document.getElementById('sizingValue').value = '5';
        document.getElementById('maxPositions').value = '5';
        document.getElementById('filterMinPrice').value = '10';
        document.getElementById('filterMinVolume').value = '500000';
        document.getElementById('universe').value = 'sp500';
        document.getElementById('filterSkipEarnings').checked = true;
        document.getElementById('customSymbols').value = '';

        // Reset condition containers
        document.getElementById('entry-root').innerHTML = `
            <div class="empty-placeholder">
                <i class="fas fa-hand-pointer me-1"></i>
                Drag indicators here or click "Add Group" for complex conditions
            </div>
        `;
        document.getElementById('exit-root').innerHTML = `
            <div class="empty-placeholder">
                <i class="fas fa-hand-pointer me-1"></i>
                Drag exit types here (Stop Loss, Take Profit, etc.)
            </div>
        `;

        // Reset logic badges
        document.querySelector('#entryConditionsContainer .logic-badge').textContent = 'ALL (AND)';
        document.querySelector('#entryConditionsContainer .logic-badge').className = 'logic-badge and';
        document.querySelector('#exitConditionsContainer .logic-badge').textContent = 'ANY (OR)';
        document.querySelector('#exitConditionsContainer .logic-badge').className = 'logic-badge or';

        document.getElementById('entry-root').dataset.logic = 'AND';
        document.getElementById('exit-root').dataset.logic = 'OR';

        initializeSortables();
        updatePreview();

        document.getElementById('strategyListSection').style.display = 'none';
        document.getElementById('builderSection').style.display = 'flex';
        document.getElementById('backtestResultsSection').style.display = 'none';
    }

    async function editStrategy(id) {
        try {
            const response = await fetch(`/api/custom-strategies/${id}/`);
            const data = await response.json();
            const s = data.strategy;

            currentStrategyId = s.id;
            conditionIdCounter = 0;

            document.getElementById('strategyName').value = s.name;
            document.getElementById('strategyNameDisplay').textContent = s.name;

            const sizing = s.definition.position_sizing || {};
            document.getElementById('sizingType').value = sizing.type || 'fixed_percent';
            document.getElementById('sizingValue').value = sizing.value || 5;
            document.getElementById('maxPositions').value = sizing.max_positions || 5;

            const filters = s.definition.filters || {};
            document.getElementById('filterMinPrice').value = filters.min_price || 10;
            document.getElementById('filterMinVolume').value = filters.min_volume || 500000;
            document.getElementById('filterSkipEarnings').checked = filters.exclude_earnings_window > 0;

            document.getElementById('universe').value = s.universe || 'sp500';
            document.getElementById('customSymbols').value = (s.custom_symbols || []).join(', ');
            document.getElementById('customSymbolsContainer').style.display =
                s.universe === 'custom' ? 'block' : 'none';

            // Load conditions into tree format
            entryConditionTree = convertToTreeFormat(s.definition.entry_conditions, s.definition.entry_logic);
            exitConditionTree = convertToTreeFormat(s.definition.exit_conditions, s.definition.exit_logic);

            // Render conditions
            renderConditionsFromTree('entry-root', entryConditionTree, 'entry');
            renderConditionsFromTree('exit-root', exitConditionTree, 'exit');

            // Update root logic badges
            const entryLogic = entryConditionTree.logic || 'AND';
            const exitLogic = exitConditionTree.logic || 'OR';

            document.querySelector('#entryConditionsContainer .logic-badge').textContent = entryLogic === 'AND' ? 'ALL (AND)' : 'ANY (OR)';
            document.querySelector('#entryConditionsContainer .logic-badge').className = `logic-badge ${entryLogic.toLowerCase()}`;
            document.getElementById('entry-root').dataset.logic = entryLogic;
            document.querySelector('#entryConditionsContainer').className = `condition-group group-${entryLogic.toLowerCase()}`;

            document.querySelector('#exitConditionsContainer .logic-badge').textContent = exitLogic === 'AND' ? 'ALL (AND)' : 'ANY (OR)';
            document.querySelector('#exitConditionsContainer .logic-badge').className = `logic-badge ${exitLogic.toLowerCase()}`;
            document.getElementById('exit-root').dataset.logic = exitLogic;
            document.querySelector('#exitConditionsContainer').className = `condition-group group-${exitLogic.toLowerCase()}`;

            initializeSortables();
            updatePreview();

            document.getElementById('strategyListSection').style.display = 'none';
            document.getElementById('builderSection').style.display = 'flex';
            document.getElementById('backtestResultsSection').style.display = 'none';
        } catch (error) {
            console.error('Error loading strategy:', error);
            alert('Error loading strategy');
        }
    }

    function convertToTreeFormat(conditions, logic) {
        if (!conditions || conditions.length === 0) {
            return { type: 'group', logic: (logic || 'AND').toUpperCase(), conditions: [] };
        }

        // Check if already in tree format
        if (conditions.type === 'group') {
            return conditions;
        }

        // Convert flat array to tree
        return {
            type: 'group',
            logic: (logic || 'AND').toUpperCase(),
            conditions: conditions.map(c => {
                if (c.type === 'group') return c;
                return { type: c.type || 'condition', ...c };
            })
        };
    }

    function renderConditionsFromTree(containerId, tree, type) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        if (!tree.conditions || tree.conditions.length === 0) {
            container.innerHTML = `
                <div class="empty-placeholder">
                    <i class="fas fa-hand-pointer me-1"></i>
                    ${type === 'entry' ? 'Drag indicators here or click "Add Group" for complex conditions' : 'Drag exit types here (Stop Loss, Take Profit, etc.)'}
                </div>
            `;
            return;
        }

        tree.conditions.forEach(cond => {
            if (cond.type === 'group') {
                renderNestedGroup(containerId, cond, type);
            } else {
                renderConditionBlock(containerId, cond, type);
            }
        });
    }

    function renderNestedGroup(parentId, group, type) {
        const container = document.getElementById(parentId);
        const groupId = `group-${++conditionIdCounter}`;
        const logic = group.logic || 'AND';

        const html = `
            <div class="condition-group group-${logic.toLowerCase()}" id="${groupId}-wrapper">
                <div class="condition-group-header">
                    <span class="logic-badge ${logic.toLowerCase()}">${logic === 'AND' ? 'ALL (AND)' : 'ANY (OR)'}</span>
                    <div>
                        <button class="btn btn-xs btn-outline-secondary me-1" onclick="toggleGroupLogic('${groupId}')">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="btn btn-xs btn-outline-danger" onclick="removeGroup('${groupId}-wrapper')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="condition-group-content" id="${groupId}" data-group-id="${groupId}" data-logic="${logic}">
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);

        // Render nested conditions
        renderConditionsFromTree(groupId, group, type);

        // Initialize sortable for nested group
        initializeSortableGroup(groupId, type);
    }

    function renderConditionBlock(parentId, cond, type) {
        const container = document.getElementById(parentId);
        const condId = `cond-${++conditionIdCounter}`;

        if (type === 'exit' || cond.type !== 'condition') {
            // Exit condition
            const exitType = cond.type;
            const html = `
                <div class="condition-block exit-condition" id="${condId}" data-type="${exitType}">
                    <i class="fas fa-grip-vertical text-muted"></i>
                    <span class="text-sm font-weight-bold">${getExitTypeName(exitType)}</span>
                    ${exitType === 'time_based' ? `
                        <input type="number" class="form-control form-control-sm" style="width: 60px;"
                               value="${cond.days || 5}" min="1" onchange="updatePreview()">
                        <span class="text-sm">days</span>
                    ` : exitType === 'indicator' ? `
                        <select class="form-select form-select-sm" style="width: 100px;" onchange="updatePreview()">
                            ${indicators.map(i => `<option value="${i.id}" ${i.id === cond.indicator ? 'selected' : ''}>${i.name}</option>`).join('')}
                        </select>
                        <select class="form-select form-select-sm" style="width: 60px;" onchange="updatePreview()">
                            ${operators.map(o => `<option value="${o.id}" ${o.id === cond.operator ? 'selected' : ''}>${o.symbol}</option>`).join('')}
                        </select>
                        <input type="number" class="form-control form-control-sm" style="width: 60px;"
                               value="${cond.value || 70}" onchange="updatePreview()">
                    ` : `
                        <input type="number" class="form-control form-control-sm" style="width: 60px;"
                               value="${cond.value || 5}" min="0" step="0.5" onchange="updatePreview()">
                        <span class="text-sm">%</span>
                    `}
                    <i class="fas fa-times text-danger remove-btn ms-auto" onclick="removeCondition('${condId}')"></i>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        } else {
            // Entry condition
            const html = `
                <div class="condition-block entry-condition" id="${condId}" data-indicator="${cond.indicator}">
                    <i class="fas fa-grip-vertical text-muted"></i>
                    <select class="form-select form-select-sm" style="width: 90px;" onchange="updatePreview()">
                        ${indicators.map(i => `<option value="${i.id}" ${i.id === cond.indicator ? 'selected' : ''}>${i.name}</option>`).join('')}
                    </select>
                    <input type="number" class="form-control form-control-sm" style="width: 50px;"
                           value="${cond.period || 14}" min="1" title="Period" onchange="updatePreview()">
                    <select class="form-select form-select-sm" style="width: 60px;" onchange="updatePreview()">
                        ${operators.map(o => `<option value="${o.id}" ${o.id === cond.operator ? 'selected' : ''}>${o.symbol}</option>`).join('')}
                    </select>
                    <input type="number" class="form-control form-control-sm" style="width: 60px;"
                           value="${cond.value || 30}" step="0.1" onchange="updatePreview()">
                    <i class="fas fa-times text-danger remove-btn ms-auto" onclick="removeCondition('${condId}')"></i>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }
    }

    function getExitTypeName(type) {
        const exit = exitTypes.find(e => e.id === type);
        return exit?.name || type;
    }

    function cancelEdit() {
        document.getElementById('strategyListSection').style.display = 'block';
        document.getElementById('builderSection').style.display = 'none';
        loadStrategies();
    }

    function getDefinition() {
        return {
            entry_conditions: entryConditionTree,
            entry_logic: entryConditionTree.logic || 'AND',
            exit_conditions: exitConditionTree,
            exit_logic: exitConditionTree.logic || 'OR',
            position_sizing: {
                type: document.getElementById('sizingType').value,
                value: parseFloat(document.getElementById('sizingValue').value) || 5,
                max_positions: parseInt(document.getElementById('maxPositions').value) || 5
            },
            filters: {
                min_price: parseFloat(document.getElementById('filterMinPrice').value) || 10,
                min_volume: parseInt(document.getElementById('filterMinVolume').value) || 500000,
                exclude_earnings_window: document.getElementById('filterSkipEarnings').checked ? 5 : 0
            }
        };
    }

    async function saveStrategy() {
        const name = document.getElementById('strategyName').value.trim();
        if (!name) {
            alert('Please enter a strategy name');
            return;
        }

        // Update condition trees from UI
        updatePreview();

        const definition = getDefinition();
        const universe = document.getElementById('universe').value;
        const customSymbols = document.getElementById('customSymbols').value
            .split(',').map(s => s.trim().toUpperCase()).filter(s => s);

        try {
            let response;
            if (currentStrategyId) {
                response = await fetch(`/api/custom-strategies/${currentStrategyId}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ name, definition, universe, custom_symbols: customSymbols })
                });
            } else {
                response = await fetch('/api/custom-strategies/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ name, definition, universe, custom_symbols: customSymbols })
                });
            }

            const data = await response.json();
            if (data.status === 'error') {
                alert(data.message);
                return;
            }

            currentStrategyId = data.strategy.id;
            document.getElementById('strategyNameDisplay').textContent = name;
            alert('Strategy saved successfully!');
        } catch (error) {
            console.error('Error saving strategy:', error);
            alert('Error saving strategy');
        }
    }

    async function validateStrategy() {
        if (!currentStrategyId) {
            await saveStrategy();
            if (!currentStrategyId) return;
        }

        try {
            const response = await fetch(`/api/custom-strategies/${currentStrategyId}/validate/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() }
            });
            const data = await response.json();

            const statusDiv = document.getElementById('validationStatus');
            const messagesDiv = document.getElementById('validationMessages');

            if (data.validation.valid) {
                statusDiv.innerHTML = '<span class="badge bg-success">Valid</span>';
            } else {
                statusDiv.innerHTML = '<span class="badge bg-danger">Invalid</span>';
            }

            let messages = '';
            if (data.validation.errors.length > 0) {
                messages += data.validation.errors.map(e =>
                    `<div class="alert alert-danger py-1 px-2 mb-1 text-sm"><i class="fas fa-times-circle me-1"></i>${e}</div>`
                ).join('');
            }
            if (data.validation.warnings.length > 0) {
                messages += data.validation.warnings.map(w =>
                    `<div class="alert alert-warning py-1 px-2 mb-1 text-sm"><i class="fas fa-exclamation-triangle me-1"></i>${w}</div>`
                ).join('');
            }
            messagesDiv.innerHTML = messages || '<div class="text-success text-sm">All checks passed!</div>';

        } catch (error) {
            console.error('Error validating:', error);
        }
    }

    async function runBacktest() {
        if (!currentStrategyId) {
            await saveStrategy();
            if (!currentStrategyId) return;
        }

        document.getElementById('backtestResultsSection').style.display = 'block';
        document.getElementById('backtestResultsContent').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Running backtest with real historical data...</p>
            </div>
        `;

        try {
            const response = await fetch(`/api/custom-strategies/${currentStrategyId}/backtest/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ period: '1Y', save_to_db: true })
            });
            const data = await response.json();

            if (data.status === 'error') {
                document.getElementById('backtestResultsContent').innerHTML = `
                    <div class="alert alert-danger">${data.message}</div>
                `;
                return;
            }

            renderBacktestResults(data.backtest);
        } catch (error) {
            console.error('Error running backtest:', error);
            document.getElementById('backtestResultsContent').innerHTML = `
                <div class="alert alert-danger">Error running backtest</div>
            `;
        }
    }

    function renderBacktestResults(results) {
        const r = results;
        document.getElementById('backtestResultsContent').innerHTML = `
            <div class="row">
                <div class="col-md-3 text-center border-end">
                    <h3 class="text-${r.total_return_pct >= 0 ? 'success' : 'danger'} mb-0">
                        ${r.total_return_pct >= 0 ? '+' : ''}${r.total_return_pct.toFixed(1)}%
                    </h3>
                    <p class="text-muted text-sm">Total Return</p>
                </div>
                <div class="col-md-3 text-center border-end">
                    <h3 class="mb-0">${r.sharpe_ratio.toFixed(2)}</h3>
                    <p class="text-muted text-sm">Sharpe Ratio</p>
                </div>
                <div class="col-md-3 text-center border-end">
                    <h3 class="text-danger mb-0">-${Math.abs(r.max_drawdown_pct).toFixed(1)}%</h3>
                    <p class="text-muted text-sm">Max Drawdown</p>
                </div>
                <div class="col-md-3 text-center">
                    <h3 class="mb-0">${r.win_rate.toFixed(0)}%</h3>
                    <p class="text-muted text-sm">Win Rate</p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr><td>Period</td><td class="text-end"><strong>${r.period || '1 Year'}</strong></td></tr>
                        <tr><td>Total Trades</td><td class="text-end"><strong>${r.total_trades}</strong></td></tr>
                        <tr><td>Winning Trades</td><td class="text-end text-success">${r.winning_trades}</td></tr>
                        <tr><td>Losing Trades</td><td class="text-end text-danger">${r.losing_trades}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr><td>Profit Factor</td><td class="text-end"><strong>${r.profit_factor?.toFixed(2) || '-'}</strong></td></tr>
                        <tr><td>Avg Win</td><td class="text-end text-success">+${r.avg_win_pct?.toFixed(1) || '-'}%</td></tr>
                        <tr><td>Avg Loss</td><td class="text-end text-danger">-${Math.abs(r.avg_loss_pct || 0).toFixed(1)}%</td></tr>
                        <tr><td>Avg Hold</td><td class="text-end">${r.avg_hold_days?.toFixed(1) || '-'} days</td></tr>
                    </table>
                </div>
            </div>
            ${r.run_id ? `<div class="text-end mt-3"><a href="/backtesting?run=${r.run_id}" class="btn btn-sm btn-outline-primary">View Full Details</a></div>` : ''}
        `;
    }

    async function deleteStrategy(id, name) {
        if (!confirm(`Delete strategy "${name}"?`)) return;

        try {
            const response = await fetch(`/api/custom-strategies/${id}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': getCsrfToken() }
            });
            const data = await response.json();

            if (data.status === 'error') {
                alert(data.message);
                return;
            }

            loadStrategies();
        } catch (error) {
            console.error('Error deleting strategy:', error);
        }
    }

    async function cloneStrategy(id) {
        try {
            const response = await fetch(`/api/custom-strategies/${id}/clone/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() }
            });
            const data = await response.json();

            if (data.status === 'success') {
                loadStrategies();
            }
        } catch (error) {
            console.error('Error cloning strategy:', error);
        }
    }

    async function activateStrategy(id) {
        try {
            const response = await fetch(`/api/custom-strategies/${id}/activate/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() }
            });
            const data = await response.json();

            if (data.status === 'error') {
                alert(data.message);
                return;
            }

            loadStrategies();
        } catch (error) {
            console.error('Error activating strategy:', error);
        }
    }

    async function deactivateStrategy(id) {
        try {
            const response = await fetch(`/api/custom-strategies/${id}/deactivate/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() }
            });
            loadStrategies();
        } catch (error) {
            console.error('Error deactivating strategy:', error);
        }
    }

    async function showTemplates() {
        const modal = new bootstrap.Modal(document.getElementById('templatesModal'));
        modal.show();

        try {
            const response = await fetch('/api/custom-strategies/templates/');
            const data = await response.json();

            document.getElementById('templatesContent').innerHTML = `
                <div class="row">
                    ${data.templates.map(t => `
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="mb-1">${t.name}</h6>
                                    <p class="text-sm text-muted mb-2">${t.description}</p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="createFromTemplate('${t.id}')">
                                        Use This Template
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (error) {
            document.getElementById('templatesContent').innerHTML = '<div class="alert alert-danger">Error loading templates</div>';
        }
    }

    async function createFromTemplate(templateId) {
        try {
            const response = await fetch('/api/custom-strategies/from-template/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ template_id: templateId })
            });
            const data = await response.json();

            bootstrap.Modal.getInstance(document.getElementById('templatesModal')).hide();

            if (data.status === 'success') {
                editStrategy(data.strategy.id);
            }
        } catch (error) {
            console.error('Error creating from template:', error);
        }
    }

    async function showIndicatorReference() {
        const modal = new bootstrap.Modal(document.getElementById('indicatorModal'));
        modal.show();

        document.getElementById('indicatorContent').innerHTML = `
            <div class="accordion" id="indicatorAccordion">
                ${indicators.map((ind, idx) => `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${idx > 0 ? 'collapsed' : ''}" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#ind${idx}">
                                <strong>${ind.name}</strong>
                                <span class="badge bg-light text-dark ms-2">${ind.id}</span>
                            </button>
                        </h2>
                        <div id="ind${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}"
                             data-bs-parent="#indicatorAccordion">
                            <div class="accordion-body">
                                <p>${ind.description}</p>
                                ${ind.default_period ? `<p class="text-sm"><strong>Default Period:</strong> ${ind.default_period}</p>` : ''}
                                ${ind.value_range ? `<p class="text-sm"><strong>Value Range:</strong> ${ind.value_range[0]} to ${ind.value_range[1]}</p>` : ''}
                                ${ind.typical_buy ? `<p class="text-sm text-success"><strong>Typical Buy Signal:</strong> < ${ind.typical_buy}</p>` : ''}
                                ${ind.typical_sell ? `<p class="text-sm text-danger"><strong>Typical Sell Signal:</strong> > ${ind.typical_sell}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
               document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1] || '';
    }
</script>
{% endblock %}
