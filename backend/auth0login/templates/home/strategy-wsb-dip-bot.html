{% extends 'layouts/base.html' %}
{% block title %} WSB Dip Bot Configuration {% endblock title %}

{% block stylesheets %}
<style>
  .param-card {
    border-left: 4px solid #cb0c9f;
    transition: all 0.3s ease;
  }
  .param-card:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  .tooltip-icon {
    cursor: help;
    color: #8898aa;
    font-size: 14px;
    margin-left: 5px;
  }
  .tooltip-icon:hover {
    color: #cb0c9f;
  }
  .profile-badge {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .profile-badge:hover {
    transform: scale(1.05);
  }
  .profile-badge.active {
    border: 2px solid #cb0c9f;
  }
  .param-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #e9ecef;
    outline: none;
  }
  .param-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: linear-gradient(310deg, #7928CA 0%, #FF0080 100%);
    cursor: pointer;
  }
  .implication-box {
    background: linear-gradient(to right, rgba(203,12,159,0.05), rgba(121,40,202,0.05));
    border-radius: 8px;
    padding: 12px;
    margin-top: 8px;
  }
  .warning-implication {
    background: linear-gradient(to right, rgba(251,99,64,0.1), rgba(245,54,92,0.05));
  }
  .safe-implication {
    background: linear-gradient(to right, rgba(45,206,137,0.1), rgba(17,205,239,0.05));
  }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid py-4">
  <!-- CSRF Token for form submissions -->
  {% csrf_token %}

  <!-- Save Status Message -->
  {% if save_message %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-{% if save_status == 'success' %}success{% elif save_status == 'error' %}danger{% else %}info{% endif %} alert-dismissible fade show" role="alert">
        <strong>{% if save_status == 'success' %}Saved!{% elif save_status == 'error' %}Error!{% else %}Info{% endif %}</strong> {{ save_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-gradient-primary">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-auto">
              <div class="icon icon-shape bg-white shadow text-center border-radius-md p-3">
                <i class="fas fa-chart-line text-primary fa-2x"></i>
              </div>
            </div>
            <div class="col">
              <h4 class="text-white mb-1">WSB Dip Bot Configuration</h4>
              <p class="text-white opacity-8 mb-0">Momentum-based dip buying strategy. Buys call options when stocks dip after a significant run-up.</p>
            </div>
            <div class="col-auto">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="strategyEnabled" checked style="width: 50px; height: 26px;">
                <label class="form-check-label text-white ms-2" for="strategyEnabled">Strategy Enabled</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Selection -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header pb-0">
          <h6><i class="fas fa-user-cog me-2"></i>Strategy Profile
            <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Profiles are pre-configured parameter sets optimized for different market conditions and trading styles"></i>
          </h6>
          <p class="text-sm text-secondary mb-0">Select a profile to auto-populate recommended settings, or customize individually below</p>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-3">
              <div class="card profile-badge active" data-profile="research_2024">
                <div class="card-body p-3 text-center">
                  <i class="fas fa-flask fa-2x text-info mb-2"></i>
                  <h6 class="mb-1">Research 2024</h6>
                  <p class="text-xs text-secondary mb-0">Conservative, backtested params</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card profile-badge" data-profile="wsb_2025">
                <div class="card-body p-3 text-center">
                  <i class="fas fa-rocket fa-2x text-primary mb-2"></i>
                  <h6 class="mb-1">WSB 2025</h6>
                  <p class="text-xs text-secondary mb-0">Aggressive momentum focus</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card profile-badge" data-profile="trump_2025">
                <div class="card-body p-3 text-center">
                  <i class="fas fa-flag-usa fa-2x text-danger mb-2"></i>
                  <h6 class="mb-1">Trump 2025</h6>
                  <p class="text-xs text-secondary mb-0">Policy-sensitive sectors</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card profile-badge" data-profile="bubble_aware">
                <div class="card-body p-3 text-center">
                  <i class="fas fa-shield-alt fa-2x text-warning mb-2"></i>
                  <h6 class="mb-1">Bubble Aware 2025</h6>
                  <p class="text-xs text-secondary mb-0">Risk-conscious, avoids froth</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Entry Signal Parameters -->
    <div class="col-lg-6 mb-4">
      <div class="card param-card h-100">
        <div class="card-header pb-0">
          <h6><i class="fas fa-door-open me-2"></i>Entry Signal Parameters</h6>
          <p class="text-xs text-secondary mb-0">Controls when the bot identifies potential dip-buying opportunities</p>
        </div>
        <div class="card-body">
          <!-- Run Lookback Days -->
          <div class="mb-4">
            <label class="form-label d-flex justify-content-between align-items-center">
              <span>
                Run Lookback Days
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="How many days back to look for a 'run-up' before the dip. Shorter = more sensitive to recent moves, Longer = catches bigger trends"></i>
              </span>
              <span class="badge bg-gradient-primary" id="runLookbackValue">7 days</span>
            </label>
            <input type="range" class="param-slider" id="runLookback" min="3" max="14" value="7">
            <div class="implication-box" id="runLookbackImplication">
              <small class="text-secondary">
                <i class="fas fa-lightbulb text-warning me-1"></i>
                <strong>Current setting:</strong> Will look for stocks that ran up in the past 7 days. Good balance between catching momentum and avoiding stale signals.
              </small>
            </div>
          </div>

          <!-- Run Threshold -->
          <div class="mb-4">
            <label class="form-label d-flex justify-content-between align-items-center">
              <span>
                Run Threshold (%)
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Minimum % gain required during lookback period to qualify as a 'run-up'. Higher = fewer but stronger setups"></i>
              </span>
              <span class="badge bg-gradient-success" id="runThresholdValue">8%</span>
            </label>
            <input type="range" class="param-slider" id="runThreshold" min="3" max="20" value="8">
            <div class="implication-box safe-implication" id="runThresholdImplication">
              <small class="text-secondary">
                <i class="fas fa-check-circle text-success me-1"></i>
                <strong>Implication:</strong> Stock must have gained at least 8% recently. This filters for strong momentum stocks and reduces false signals.
              </small>
            </div>
          </div>

          <!-- Dip Threshold -->
          <div class="mb-4">
            <label class="form-label d-flex justify-content-between align-items-center">
              <span>
                Dip Threshold (%)
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Minimum % pullback from recent high to trigger entry. Too small = premature entries, Too large = might miss the bounce"></i>
              </span>
              <span class="badge bg-gradient-danger" id="dipThresholdValue">-2%</span>
            </label>
            <input type="range" class="param-slider" id="dipThreshold" min="-10" max="-1" value="-2">
            <div class="implication-box warning-implication" id="dipThresholdImplication">
              <small class="text-secondary">
                <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                <strong>Warning:</strong> -2% is aggressive. Consider -3% to -5% for more confirmation that the dip is real and not just noise.
              </small>
            </div>
          </div>

          <!-- WSB Sentiment Weight -->
          <div class="mb-4">
            <label class="form-label d-flex justify-content-between align-items-center">
              <span>
                WSB Sentiment Weight
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="How much to factor in Reddit/WSB sentiment. Higher = more influenced by social media buzz, 0 = pure technicals"></i>
              </span>
              <span class="badge bg-gradient-info" id="wsbWeightValue">30%</span>
            </label>
            <input type="range" class="param-slider" id="wsbWeight" min="0" max="100" value="30">
            <div class="implication-box" id="wsbWeightImplication">
              <small class="text-secondary">
                <i class="fas fa-users text-info me-1"></i>
                <strong>Effect:</strong> Adds 30% weight to WSB/social sentiment. Boosts entries on high-buzz tickers. Set to 0 for pure technical trading.
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Options Parameters -->
    <div class="col-lg-6 mb-4">
      <div class="card param-card h-100">
        <div class="card-header pb-0">
          <h6><i class="fas fa-file-contract me-2"></i>Options Contract Parameters</h6>
          <p class="text-xs text-secondary mb-0">Controls which options contracts are selected for trades</p>
        </div>
        <div class="card-body">
          <!-- Target DTE -->
          <div class="mb-4">
            <label class="form-label d-flex justify-content-between align-items-center">
              <span>
                Target DTE (Days to Expiry)
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Days until option expiration. Shorter = cheaper premium but faster theta decay. Longer = more time for trade to work but costs more"></i>
              </span>
              <span class="badge bg-gradient-primary" id="targetDteValue">21 days</span>
            </label>
            <input type="range" class="param-slider" id="targetDte" min="7" max="45" value="21">
            <div class="implication-box" id="targetDteImplication">
              <small class="text-secondary">
                <i class="fas fa-clock text-primary me-1"></i>
                <strong>Trade-off:</strong> 21 DTE gives ~3 weeks for the stock to recover. Theta decay accelerates after 21 DTE, so consider exiting before then.
              </small>
            </div>
          </div>

          <!-- OTM Percentage -->
          <div class="mb-4">
            <label class="form-label d-flex justify-content-between align-items-center">
              <span>
                OTM Percentage
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="How far out-of-the-money to buy calls. Higher = cheaper but lower probability. Lower = more expensive but higher win rate"></i>
              </span>
              <span class="badge bg-gradient-warning" id="otmPctValue">3%</span>
            </label>
            <input type="range" class="param-slider" id="otmPct" min="0" max="15" value="3">
            <div class="implication-box" id="otmPctImplication">
              <small class="text-secondary">
                <i class="fas fa-coins text-warning me-1"></i>
                <strong>Example:</strong> For a $100 stock, 3% OTM means buying $103 strike calls. Cheaper than ATM but needs 3%+ move to profit at expiry.
              </small>
            </div>
          </div>

          <!-- Target Delta -->
          <div class="mb-4">
            <label class="form-label d-flex justify-content-between align-items-center">
              <span>
                Target Delta
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Option delta target. 0.50 = ATM, 0.30 = moderately OTM, 0.15 = far OTM. Higher delta = more $ per point but costs more"></i>
              </span>
              <span class="badge bg-gradient-info" id="deltaTargetValue">0.50</span>
            </label>
            <input type="range" class="param-slider" id="deltaTarget" min="15" max="70" value="50">
            <div class="implication-box" id="deltaTargetImplication">
              <small class="text-secondary">
                <i class="fas fa-chart-line text-info me-1"></i>
                <strong>Delta 0.50:</strong> Roughly 50% chance of expiring ITM. $1 stock move = ~$0.50 option price change. Good risk/reward balance.
              </small>
            </div>
          </div>

          <!-- Target Profit Multiplier -->
          <div class="mb-4">
            <label class="form-label d-flex justify-content-between align-items-center">
              <span>
                Target Profit Multiplier
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Exit when option value reaches this multiple of entry price. 2.0 = 100% profit, 3.0 = 200% profit. Higher = more gains but fewer winners"></i>
              </span>
              <span class="badge bg-gradient-success" id="profitMultiplierValue">2.5x</span>
            </label>
            <input type="range" class="param-slider" id="profitMultiplier" min="15" max="50" value="25">
            <div class="implication-box safe-implication" id="profitMultiplierImplication">
              <small class="text-secondary">
                <i class="fas fa-bullseye text-success me-1"></i>
                <strong>Target:</strong> Exit when position is worth 2.5x entry price (150% gain). This is aggressive - consider 1.5x-2.0x for more consistent exits.
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Risk & Position Management -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card param-card">
        <div class="card-header pb-0">
          <h6><i class="fas fa-shield-alt me-2"></i>Risk & Position Management</h6>
          <p class="text-xs text-secondary mb-0">Controls position sizing, stop losses, and risk limits for this strategy</p>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Position Size -->
            <div class="col-md-4 mb-4">
              <label class="form-label d-flex justify-content-between align-items-center">
                <span>
                  Max Position Size (% of Portfolio)
                  <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Maximum % of portfolio to allocate to a single WSB Dip Bot trade. Lower = safer diversification, Higher = more concentrated bets"></i>
                </span>
                <span class="badge bg-gradient-primary" id="positionSizeValue">3%</span>
              </label>
              <input type="range" class="param-slider" id="positionSize" min="1" max="10" value="3">
              <div class="implication-box">
                <small class="text-secondary">
                  <i class="fas fa-balance-scale text-primary me-1"></i>
                  <strong>Risk level:</strong> At 3%, a total loss only costs 3% of portfolio. Conservative for options trading.
                </small>
              </div>
            </div>

            <!-- Stop Loss -->
            <div class="col-md-4 mb-4">
              <label class="form-label d-flex justify-content-between align-items-center">
                <span>
                  Stop Loss (% of Position)
                  <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Exit if position loses this % of value. Options are volatile - too tight stops get triggered by normal swings"></i>
                </span>
                <span class="badge bg-gradient-danger" id="stopLossValue">50%</span>
              </label>
              <input type="range" class="param-slider" id="stopLoss" min="20" max="100" value="50">
              <div class="implication-box warning-implication">
                <small class="text-secondary">
                  <i class="fas fa-hand-paper text-danger me-1"></i>
                  <strong>Note:</strong> 50% stop on options is wide. Options can easily swing 30-40% intraday. Tighter stops may get stopped out prematurely.
                </small>
              </div>
            </div>

            <!-- Max Concurrent Positions -->
            <div class="col-md-4 mb-4">
              <label class="form-label d-flex justify-content-between align-items-center">
                <span>
                  Max Concurrent Positions
                  <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Maximum number of open WSB Dip Bot positions at once. More positions = more diversification but harder to manage"></i>
                </span>
                <span class="badge bg-gradient-info" id="maxPositionsValue">5</span>
              </label>
              <input type="range" class="param-slider" id="maxPositions" min="1" max="15" value="5">
              <div class="implication-box">
                <small class="text-secondary">
                  <i class="fas fa-layer-group text-info me-1"></i>
                  <strong>Diversification:</strong> 5 positions at 3% each = max 15% of portfolio in this strategy.
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bubble Aware Settings (Conditional) -->
  <div class="row mb-4" id="bubbleAwareSection" style="display: none;">
    <div class="col-12">
      <div class="card param-card" style="border-left-color: #ffc107;">
        <div class="card-header pb-0 bg-gradient-warning text-white">
          <h6 class="text-white"><i class="fas fa-exclamation-triangle me-2"></i>Bubble Aware Settings</h6>
          <p class="text-xs text-white opacity-8 mb-0">Additional risk filters for the Bubble Aware 2025 profile</p>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">
                AI Exposure Limit
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Maximum exposure to AI/tech bubble stocks like NVDA, AMD, etc."></i>
              </label>
              <div class="input-group">
                <input type="number" class="form-control" value="15" min="0" max="50">
                <span class="input-group-text">%</span>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">
                Avoid Post-Gap Hours
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Skip euphoric gap-up scenarios for N hours"></i>
              </label>
              <div class="input-group">
                <input type="number" class="form-control" value="2" min="0" max="24">
                <span class="input-group-text">hours</span>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">
                Overvaluation P/S Threshold
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Skip stocks with Price-to-Sales ratio above this value"></i>
              </label>
              <input type="number" class="form-control" value="35" min="10" max="100">
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="newsResolution" checked>
                <label class="form-check-label" for="newsResolution">Require News Resolution</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="overvaluationFilter" checked>
                <label class="form-check-label" for="overvaluationFilter">Enable Overvaluation Filter</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Watchlist -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card param-card">
        <div class="card-header pb-0">
          <h6><i class="fas fa-list me-2"></i>Watchlist Configuration</h6>
          <p class="text-xs text-secondary mb-0">Specify which tickers the strategy should monitor for opportunities</p>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label">
                Custom Watchlist
                <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Enter comma-separated tickers. Leave empty to use default high-momentum watchlist"></i>
              </label>
              <input type="text" class="form-control" id="watchlist" placeholder="AAPL, MSFT, GOOGL, TSLA, NVDA, AMD, META, AMZN">
              <small class="text-secondary">Default: Top momentum stocks with high options liquidity</small>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Scan Interval</label>
              <select class="form-select" id="scanInterval">
                <option value="60">Every 1 minute</option>
                <option value="300" selected>Every 5 minutes</option>
                <option value="900">Every 15 minutes</option>
                <option value="1800">Every 30 minutes</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <button class="btn btn-outline-secondary mb-0" id="resetDefaultsBtn">
                <i class="fas fa-undo me-2"></i>Reset to Profile Defaults
              </button>
              <button class="btn btn-outline-info mb-0 ms-2" id="importConfigBtn">
                <i class="fas fa-upload me-2"></i>Import Config
              </button>
              <button class="btn btn-outline-info mb-0 ms-2" id="exportConfigBtn">
                <i class="fas fa-download me-2"></i>Export Config
              </button>
            </div>
            <div>
              <button class="btn btn-outline-warning mb-0 me-2" id="backtestBtn">
                <i class="fas fa-history me-2"></i>Backtest Settings
              </button>
              <button class="btn bg-gradient-success mb-0" id="saveConfigBtn">
                <i class="fas fa-save me-2"></i>Save Configuration
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include "includes/footer.html" %}
</div>
{% endblock content %}

{% block javascripts %}
<script>
  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  });

  // Profile configurations
  const profiles = {
    research_2024: {
      runLookback: 7, runThreshold: 8, dipThreshold: -2, wsbWeight: 30,
      targetDte: 21, otmPct: 3, deltaTarget: 50, profitMultiplier: 25,
      positionSize: 3, stopLoss: 50, maxPositions: 5
    },
    wsb_2025: {
      runLookback: 5, runThreshold: 7, dipThreshold: -1.8, wsbWeight: 25,
      targetDte: 14, otmPct: 2, deltaTarget: 45, profitMultiplier: 22,
      positionSize: 4, stopLoss: 60, maxPositions: 6
    },
    trump_2025: {
      runLookback: 6, runThreshold: 7, dipThreshold: -2, wsbWeight: 20,
      targetDte: 18, otmPct: 2.5, deltaTarget: 48, profitMultiplier: 22,
      positionSize: 3, stopLoss: 50, maxPositions: 5
    },
    bubble_aware: {
      runLookback: 6, runThreshold: 7, dipThreshold: -1.8, wsbWeight: 30,
      targetDte: 18, otmPct: 2.5, deltaTarget: 50, profitMultiplier: 22,
      positionSize: 2, stopLoss: 40, maxPositions: 4
    }
  };

  // Profile selection
  document.querySelectorAll('.profile-badge').forEach(badge => {
    badge.addEventListener('click', function() {
      document.querySelectorAll('.profile-badge').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      const profile = this.dataset.profile;
      applyProfile(profiles[profile]);

      // Show/hide bubble aware section
      document.getElementById('bubbleAwareSection').style.display =
        profile === 'bubble_aware' ? 'block' : 'none';
    });
  });

  function applyProfile(config) {
    document.getElementById('runLookback').value = config.runLookback;
    document.getElementById('runLookbackValue').textContent = config.runLookback + ' days';
    document.getElementById('runThreshold').value = config.runThreshold;
    document.getElementById('runThresholdValue').textContent = config.runThreshold + '%';
    document.getElementById('dipThreshold').value = config.dipThreshold;
    document.getElementById('dipThresholdValue').textContent = config.dipThreshold + '%';
    document.getElementById('wsbWeight').value = config.wsbWeight;
    document.getElementById('wsbWeightValue').textContent = config.wsbWeight + '%';
    document.getElementById('targetDte').value = config.targetDte;
    document.getElementById('targetDteValue').textContent = config.targetDte + ' days';
    document.getElementById('otmPct').value = config.otmPct;
    document.getElementById('otmPctValue').textContent = config.otmPct + '%';
    document.getElementById('deltaTarget').value = config.deltaTarget;
    document.getElementById('deltaTargetValue').textContent = (config.deltaTarget / 100).toFixed(2);
    document.getElementById('profitMultiplier').value = config.profitMultiplier;
    document.getElementById('profitMultiplierValue').textContent = (config.profitMultiplier / 10).toFixed(1) + 'x';
    document.getElementById('positionSize').value = config.positionSize;
    document.getElementById('positionSizeValue').textContent = config.positionSize + '%';
    document.getElementById('stopLoss').value = config.stopLoss;
    document.getElementById('stopLossValue').textContent = config.stopLoss + '%';
    document.getElementById('maxPositions').value = config.maxPositions;
    document.getElementById('maxPositionsValue').textContent = config.maxPositions;
    updateAllImplications();
  }

  // Slider updates with implications
  function updateImplication(id, value, implicationId, implicationFn) {
    document.getElementById(id + 'Value').textContent = value;
    const implicationEl = document.getElementById(implicationId);
    if (implicationEl && implicationFn) {
      implicationEl.innerHTML = implicationFn(value);
    }
  }

  document.getElementById('runLookback').addEventListener('input', function() {
    document.getElementById('runLookbackValue').textContent = this.value + ' days';
    updateRunLookbackImplication(this.value);
  });

  document.getElementById('runThreshold').addEventListener('input', function() {
    document.getElementById('runThresholdValue').textContent = this.value + '%';
  });

  document.getElementById('dipThreshold').addEventListener('input', function() {
    document.getElementById('dipThresholdValue').textContent = this.value + '%';
    updateDipImplication(this.value);
  });

  document.getElementById('wsbWeight').addEventListener('input', function() {
    document.getElementById('wsbWeightValue').textContent = this.value + '%';
  });

  document.getElementById('targetDte').addEventListener('input', function() {
    document.getElementById('targetDteValue').textContent = this.value + ' days';
    updateDteImplication(this.value);
  });

  document.getElementById('otmPct').addEventListener('input', function() {
    document.getElementById('otmPctValue').textContent = this.value + '%';
  });

  document.getElementById('deltaTarget').addEventListener('input', function() {
    document.getElementById('deltaTargetValue').textContent = (this.value / 100).toFixed(2);
  });

  document.getElementById('profitMultiplier').addEventListener('input', function() {
    document.getElementById('profitMultiplierValue').textContent = (this.value / 10).toFixed(1) + 'x';
  });

  document.getElementById('positionSize').addEventListener('input', function() {
    document.getElementById('positionSizeValue').textContent = this.value + '%';
  });

  document.getElementById('stopLoss').addEventListener('input', function() {
    document.getElementById('stopLossValue').textContent = this.value + '%';
  });

  document.getElementById('maxPositions').addEventListener('input', function() {
    document.getElementById('maxPositionsValue').textContent = this.value;
  });

  function updateRunLookbackImplication(days) {
    const el = document.getElementById('runLookbackImplication');
    if (days <= 4) {
      el.innerHTML = '<small class="text-secondary"><i class="fas fa-bolt text-warning me-1"></i><strong>Short lookback:</strong> Very responsive to recent moves. May catch quick bounces but also more false signals.</small>';
    } else if (days <= 7) {
      el.innerHTML = '<small class="text-secondary"><i class="fas fa-lightbulb text-warning me-1"></i><strong>Balanced:</strong> Good balance between catching momentum and filtering noise.</small>';
    } else {
      el.innerHTML = '<small class="text-secondary"><i class="fas fa-clock text-info me-1"></i><strong>Long lookback:</strong> Catches bigger trends but may miss quick reversals. More conservative.</small>';
    }
  }

  function updateDipImplication(dip) {
    const el = document.getElementById('dipThresholdImplication');
    if (dip > -2) {
      el.className = 'implication-box warning-implication';
      el.innerHTML = '<small class="text-secondary"><i class="fas fa-exclamation-triangle text-danger me-1"></i><strong>Very aggressive:</strong> ' + dip + '% dip threshold may trigger on normal volatility. High risk of false signals.</small>';
    } else if (dip > -4) {
      el.className = 'implication-box';
      el.innerHTML = '<small class="text-secondary"><i class="fas fa-check-circle text-success me-1"></i><strong>Moderate:</strong> ' + dip + '% pullback is reasonable. Filters out small fluctuations while catching real dips.</small>';
    } else {
      el.className = 'implication-box safe-implication';
      el.innerHTML = '<small class="text-secondary"><i class="fas fa-shield-alt text-success me-1"></i><strong>Conservative:</strong> ' + dip + '% requires significant pullback. Fewer trades but higher conviction entries.</small>';
    }
  }

  function updateDteImplication(dte) {
    const el = document.getElementById('targetDteImplication');
    if (dte < 14) {
      el.innerHTML = '<small class="text-secondary"><i class="fas fa-fire text-danger me-1"></i><strong>Short DTE:</strong> Fast theta decay. Need quick moves. Higher gamma but less time to be right.</small>';
    } else if (dte < 28) {
      el.innerHTML = '<small class="text-secondary"><i class="fas fa-clock text-primary me-1"></i><strong>Sweet spot:</strong> ' + dte + ' DTE balances cost and time decay. Consider exiting before 7 DTE.</small>';
    } else {
      el.innerHTML = '<small class="text-secondary"><i class="fas fa-calendar text-info me-1"></i><strong>Longer DTE:</strong> More time for thesis to play out but higher premium cost. Good for swing trades.</small>';
    }
  }

  function updateAllImplications() {
    updateRunLookbackImplication(document.getElementById('runLookback').value);
    updateDipImplication(document.getElementById('dipThreshold').value);
    updateDteImplication(document.getElementById('targetDte').value);
  }

  // Save configuration via form submission
  document.getElementById('saveConfigBtn').addEventListener('click', function() {
    // Create and submit a form with all configuration values
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '';

    // Add CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                      document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
    form.appendChild(csrfInput);

    // Add action
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'save_config';
    form.appendChild(actionInput);

    // Add all configuration values
    const configFields = {
      'run_lookback': document.getElementById('runLookback').value,
      'run_threshold': document.getElementById('runThreshold').value,
      'dip_threshold': document.getElementById('dipThreshold').value,
      'wsb_weight': document.getElementById('wsbWeight').value,
      'target_dte': document.getElementById('targetDte').value,
      'otm_pct': document.getElementById('otmPct').value,
      'delta_target': document.getElementById('deltaTarget').value,
      'profit_multiplier': document.getElementById('profitMultiplier').value,
      'position_size': document.getElementById('positionSize').value,
      'stop_loss': document.getElementById('stopLoss').value,
      'max_positions': document.getElementById('maxPositions').value,
      'watchlist': document.getElementById('watchlist').value,
      'scan_interval': document.getElementById('scanInterval').value,
      'strategy_enabled': document.getElementById('strategyEnabled').checked ? 'on' : ''
    };

    for (const [name, value] of Object.entries(configFields)) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.value = value;
      form.appendChild(input);
    }

    document.body.appendChild(form);
    form.submit();
  });

  // Backtest button
  document.getElementById('backtestBtn').addEventListener('click', function() {
    window.location.href = '/backtesting?strategy=wsb-dip-bot';
  });

  // Export config
  document.getElementById('exportConfigBtn').addEventListener('click', function() {
    const config = {
      strategy: 'wsb_dip_bot',
      version: '1.0',
      parameters: {
        run_lookback_days: parseInt(document.getElementById('runLookback').value),
        run_threshold: parseFloat(document.getElementById('runThreshold').value) / 100,
        dip_threshold: parseFloat(document.getElementById('dipThreshold').value) / 100,
        wsb_sentiment_weight: parseFloat(document.getElementById('wsbWeight').value) / 100,
        target_dte_days: parseInt(document.getElementById('targetDte').value),
        otm_percentage: parseFloat(document.getElementById('otmPct').value) / 100,
        delta_target: parseFloat(document.getElementById('deltaTarget').value) / 100,
        target_multiplier: parseFloat(document.getElementById('profitMultiplier').value) / 10,
        max_position_size: parseFloat(document.getElementById('positionSize').value) / 100,
        stop_loss: parseFloat(document.getElementById('stopLoss').value) / 100,
        max_positions: parseInt(document.getElementById('maxPositions').value)
      }
    };
    const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'wsb_dip_bot_config.json';
    a.click();
  });
</script>
{% endblock javascripts %}
