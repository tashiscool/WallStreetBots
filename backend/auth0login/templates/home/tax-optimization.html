{% extends "layouts/base.html" %}

{% block title %} Tax Optimization {% endblock %}

{% block stylesheets %}
<style>
  .tax-card {
    background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.1);
  }
  .stat-value {
    font-size: 28px;
    font-weight: 700;
  }
  .stat-label {
    font-size: 12px;
    text-transform: uppercase;
    opacity: 0.7;
  }
  .gain-positive { color: #22c55e; }
  .gain-negative { color: #ef4444; }
  .wash-sale-warning {
    background: rgba(239, 68, 68, 0.1);
    border-left: 4px solid #ef4444;
    padding: 12px;
    margin: 10px 0;
    border-radius: 4px;
  }
  .harvest-opportunity {
    background: rgba(34, 197, 94, 0.1);
    border-left: 4px solid #22c55e;
    padding: 12px;
    margin: 10px 0;
    border-radius: 4px;
  }
  .lot-row:hover {
    background: rgba(255,255,255,0.05);
  }
  .holding-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
  }
  .badge-long-term {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
  }
  .badge-short-term {
    background: rgba(234, 179, 8, 0.2);
    color: #eab308;
  }
  .disclaimer-box {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  .method-selector {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .method-btn {
    padding: 6px 12px;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 4px;
    background: transparent;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
  }
  .method-btn:hover, .method-btn.active {
    background: rgba(99, 102, 241, 0.3);
    border-color: #6366f1;
  }
</style>
{% endblock stylesheets %}

{% block content %}

<div class="container-fluid py-4">
  <!-- Disclaimer -->
  <div class="disclaimer-box">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Important:</strong> {{ disclaimer }}
  </div>

  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h3 class="text-white mb-0">
        <i class="fas fa-chart-pie me-2"></i>Tax Optimization Dashboard
      </h3>
      <p class="text-white-50 mt-2">
        Track tax lots, harvest losses, and preview tax impact before trading
      </p>
    </div>
  </div>

  <!-- Year Summary Cards -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="tax-card">
        <div class="stat-label">Net Gain/Loss (YTD)</div>
        <div class="stat-value {% if year_summary.net_gain_loss >= 0 %}gain-positive{% else %}gain-negative{% endif %}">
          {% if year_summary.net_gain_loss >= 0 %}+{% endif %}${{ year_summary.net_gain_loss|floatformat:2 }}
        </div>
        <div class="text-white-50 mt-2">
          {{ year_summary.total_sales }} sales in {{ year_summary.year }}
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="tax-card">
        <div class="stat-label">Short-Term Net</div>
        <div class="stat-value {% if year_summary.short_term.net >= 0 %}gain-positive{% else %}gain-negative{% endif %}">
          {% if year_summary.short_term.net >= 0 %}+{% endif %}${{ year_summary.short_term.net|floatformat:2 }}
        </div>
        <div class="text-white-50 mt-2">
          Taxed as ordinary income (up to 37%)
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="tax-card">
        <div class="stat-label">Long-Term Net</div>
        <div class="stat-value {% if year_summary.long_term.net >= 0 %}gain-positive{% else %}gain-negative{% endif %}">
          {% if year_summary.long_term.net >= 0 %}+{% endif %}${{ year_summary.long_term.net|floatformat:2 }}
        </div>
        <div class="text-white-50 mt-2">
          Preferential rate (0-20%)
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="tax-card">
        <div class="stat-label">Est. Tax Liability</div>
        <div class="stat-value gain-negative">
          ${{ year_summary.estimated_tax_liability.total|floatformat:2 }}
        </div>
        <div class="text-white-50 mt-2">
          <span title="Short-term tax">ST: ${{ year_summary.estimated_tax_liability.short_term_tax|floatformat:2 }}</span> |
          <span title="Long-term tax">LT: ${{ year_summary.estimated_tax_liability.long_term_tax|floatformat:2 }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Harvesting Opportunities -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header pb-0">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="fas fa-leaf me-2 text-success"></i>Loss Harvesting Opportunities
            </h6>
            <span class="badge bg-gradient-success">{{ opportunities|length }} found</span>
          </div>
        </div>
        <div class="card-body pt-3">
          {% if opportunities %}
            {% for opp in opportunities %}
            <div class="harvest-opportunity">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong class="text-white">{{ opp.symbol }}</strong>
                  <span class="holding-badge {% if opp.is_long_term %}badge-long-term{% else %}badge-short-term{% endif %} ms-2">
                    {% if opp.is_long_term %}Long-Term{% else %}Short-Term{% endif %}
                  </span>
                </div>
                <div class="text-end">
                  <div class="gain-negative fw-bold">
                    ${{ opp.potential_loss|floatformat:2 }}
                  </div>
                  <small class="text-white-50">
                    Est. savings: ${{ opp.tax_savings_estimate.estimated_savings|floatformat:2 }}
                  </small>
                </div>
              </div>

              {% if opp.wash_sale_risk.is_risky %}
              <div class="wash-sale-warning mt-2">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <strong>Wash Sale Risk:</strong> {{ opp.wash_sale_risk.recommendation }}
              </div>
              {% endif %}

              <div class="mt-2">
                <small class="text-white-50">{{ opp.recommendation }}</small>
              </div>

              {% if opp.similar_alternatives %}
              <div class="mt-2">
                <small class="text-white-50">
                  <i class="fas fa-exchange-alt me-1"></i>Alternatives:
                  {% for alt in opp.similar_alternatives %}
                    <span class="badge bg-dark">{{ alt.symbol }}</span>
                  {% endfor %}
                </small>
              </div>
              {% endif %}

              <div class="mt-3">
                <button class="btn btn-sm btn-outline-success"
                        onclick="previewSale('{{ opp.symbol }}', {{ opp.lot.remaining_quantity }})">
                  <i class="fas fa-calculator me-1"></i>Preview Tax Impact
                </button>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center text-white-50 py-4">
              <i class="fas fa-check-circle fa-2x mb-3"></i>
              <p class="mb-0">No significant harvesting opportunities found</p>
              <small>Positions with losses over $100 will appear here</small>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Tax Lot Preview Tool -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header pb-0">
          <h6 class="mb-0">
            <i class="fas fa-calculator me-2 text-info"></i>Pre-Trade Tax Impact Preview
          </h6>
        </div>
        <div class="card-body">
          <form id="previewForm" class="mb-4">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label text-white-50">Symbol</label>
                <input type="text" class="form-control" id="preview_symbol"
                       placeholder="AAPL" required>
              </div>
              <div class="col-md-4">
                <label class="form-label text-white-50">Quantity</label>
                <input type="number" class="form-control" id="preview_quantity"
                       placeholder="100" step="0.01" required>
              </div>
              <div class="col-md-4">
                <label class="form-label text-white-50">Sale Price</label>
                <input type="number" class="form-control" id="preview_price"
                       placeholder="150.00" step="0.01" required>
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label text-white-50">Lot Selection Method</label>
              <div class="method-selector">
                <button type="button" class="method-btn active" data-method="fifo">
                  FIFO <small>(First In)</small>
                </button>
                <button type="button" class="method-btn" data-method="lifo">
                  LIFO <small>(Last In)</small>
                </button>
                <button type="button" class="method-btn" data-method="hifo">
                  HIFO <small>(Highest Cost)</small>
                </button>
              </div>
              <input type="hidden" id="preview_method" value="fifo">
            </div>
            <div class="mt-3">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search me-1"></i>Preview Tax Impact
              </button>
              <button type="button" class="btn btn-outline-secondary ms-2" id="checkWashSale">
                <i class="fas fa-exclamation-triangle me-1"></i>Check Wash Sale
              </button>
            </div>
          </form>

          <div id="previewResults" class="d-none">
            <!-- Results populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tax Lots by Symbol -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header pb-0">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="fas fa-layer-group me-2"></i>Tax Lots ({{ total_lots }} open)
            </h6>
            <div>
              <button class="btn btn-sm btn-outline-info" onclick="refreshPrices()">
                <i class="fas fa-sync-alt me-1"></i>Refresh Prices
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          {% if lots_by_symbol %}
            {% for symbol, lots in lots_by_symbol.items %}
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-white mb-0">
                  <i class="fas fa-chart-line me-2"></i>{{ symbol }}
                  <span class="badge bg-dark ms-2">{{ lots|length }} lot{{ lots|length|pluralize }}</span>
                </h6>
                <button class="btn btn-sm btn-outline-secondary"
                        onclick="toggleSymbolDetails('{{ symbol }}')">
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>
              <div class="table-responsive" id="lots_{{ symbol }}">
                <table class="table table-sm text-white">
                  <thead>
                    <tr class="text-white-50">
                      <th>Acquired</th>
                      <th class="text-end">Qty</th>
                      <th class="text-end">Cost Basis</th>
                      <th class="text-end">Current</th>
                      <th class="text-end">Gain/Loss</th>
                      <th>Term</th>
                      <th class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for lot in lots %}
                    <tr class="lot-row">
                      <td>
                        {{ lot.acquired_at|slice:":10" }}
                        <br><small class="text-white-50">{{ lot.days_held }} days</small>
                      </td>
                      <td class="text-end">{{ lot.remaining_quantity|floatformat:2 }}</td>
                      <td class="text-end">${{ lot.cost_basis_per_share|floatformat:2 }}</td>
                      <td class="text-end">
                        {% if lot.current_price %}
                          ${{ lot.current_price|floatformat:2 }}
                        {% else %}
                          <span class="text-white-50">--</span>
                        {% endif %}
                      </td>
                      <td class="text-end">
                        {% if lot.unrealized_gain %}
                          <span class="{% if lot.unrealized_gain >= 0 %}gain-positive{% else %}gain-negative{% endif %}">
                            {% if lot.unrealized_gain >= 0 %}+{% endif %}${{ lot.unrealized_gain|floatformat:2 }}
                          </span>
                          <br>
                          <small class="{% if lot.unrealized_gain_pct >= 0 %}gain-positive{% else %}gain-negative{% endif %}">
                            ({{ lot.unrealized_gain_pct|floatformat:1 }}%)
                          </small>
                        {% else %}
                          <span class="text-white-50">--</span>
                        {% endif %}
                      </td>
                      <td>
                        <span class="holding-badge {% if lot.is_long_term %}badge-long-term{% else %}badge-short-term{% endif %}">
                          {% if lot.is_long_term %}Long{% else %}Short{% endif %}
                        </span>
                      </td>
                      <td class="text-center">
                        <button class="btn btn-sm btn-link text-info p-0"
                                onclick="previewSale('{{ symbol }}', {{ lot.remaining_quantity }})"
                                title="Preview sale">
                          <i class="fas fa-calculator"></i>
                        </button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center text-white-50 py-5">
              <i class="fas fa-folder-open fa-3x mb-3"></i>
              <p class="mb-0">No tax lots found</p>
              <small>Tax lots are created automatically when you make purchases</small>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

{% endblock content %}

{% block javascripts %}
<script>
// Method selector
document.querySelectorAll('.method-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    document.getElementById('preview_method').value = this.dataset.method;
  });
});

// Preview form submission
document.getElementById('previewForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const symbol = document.getElementById('preview_symbol').value;
  const quantity = document.getElementById('preview_quantity').value;
  const price = document.getElementById('preview_price').value;
  const method = document.getElementById('preview_method').value;

  try {
    const response = await fetch('/api/tax/preview-sale/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({
        symbol: symbol,
        quantity: parseFloat(quantity),
        sale_price: parseFloat(price),
        lot_selection: method,
      }),
    });

    const data = await response.json();
    displayPreviewResults(data);
  } catch (error) {
    console.error('Error:', error);
    alert('Error previewing sale. Please try again.');
  }
});

// Check wash sale button
document.getElementById('checkWashSale').addEventListener('click', async function() {
  const symbol = document.getElementById('preview_symbol').value;
  if (!symbol) {
    alert('Please enter a symbol first');
    return;
  }

  try {
    const response = await fetch(`/api/tax/wash-sale-check/${symbol}/`);
    const data = await response.json();
    displayWashSaleCheck(data);
  } catch (error) {
    console.error('Error:', error);
    alert('Error checking wash sale risk. Please try again.');
  }
});

function displayPreviewResults(data) {
  const container = document.getElementById('previewResults');
  container.classList.remove('d-none');

  if (data.status === 'error') {
    container.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-circle me-2"></i>${data.message}
      </div>
    `;
    return;
  }

  const summary = data.summary;
  const gainClass = summary.total_gain_loss >= 0 ? 'gain-positive' : 'gain-negative';
  const gainSign = summary.total_gain_loss >= 0 ? '+' : '';

  let html = `
    <div class="tax-card">
      <h6 class="text-white mb-3">
        <i class="fas fa-receipt me-2"></i>Tax Impact Preview: ${data.symbol}
      </h6>
      <div class="row g-3 mb-3">
        <div class="col-6">
          <div class="text-white-50">Proceeds</div>
          <div class="text-white fw-bold">$${summary.total_proceeds.toFixed(2)}</div>
        </div>
        <div class="col-6">
          <div class="text-white-50">Cost Basis</div>
          <div class="text-white fw-bold">$${summary.total_cost_basis.toFixed(2)}</div>
        </div>
        <div class="col-6">
          <div class="text-white-50">Total Gain/Loss</div>
          <div class="${gainClass} fw-bold">${gainSign}$${summary.total_gain_loss.toFixed(2)}</div>
        </div>
        <div class="col-6">
          <div class="text-white-50">Estimated Tax</div>
          <div class="gain-negative fw-bold">$${summary.total_estimated_tax.toFixed(2)}</div>
        </div>
      </div>
      <div class="row g-3 mb-3">
        <div class="col-6">
          <small class="text-white-50">Short-Term: ${gainSign}$${summary.short_term_gain_loss.toFixed(2)}</small>
        </div>
        <div class="col-6">
          <small class="text-white-50">Long-Term: ${gainSign}$${summary.long_term_gain_loss.toFixed(2)}</small>
        </div>
      </div>
  `;

  if (data.wash_sale_warning && data.wash_sale_warning.is_risky) {
    html += `
      <div class="wash-sale-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Wash Sale Risk:</strong> ${data.wash_sale_warning.recommendation}
      </div>
    `;
  }

  html += `
      <div class="mt-3">
        <h6 class="text-white-50 mb-2">Lots to Sell (${data.lot_selection_method.toUpperCase()})</h6>
        <div class="table-responsive">
          <table class="table table-sm text-white mb-0">
            <thead>
              <tr class="text-white-50">
                <th>Acquired</th>
                <th class="text-end">Qty</th>
                <th class="text-end">Cost</th>
                <th class="text-end">Gain/Loss</th>
                <th>Term</th>
              </tr>
            </thead>
            <tbody>
  `;

  data.lots_to_sell.forEach(lot => {
    const lotGainClass = lot.gain_loss >= 0 ? 'gain-positive' : 'gain-negative';
    const lotSign = lot.gain_loss >= 0 ? '+' : '';
    const termBadge = lot.is_long_term ? 'badge-long-term' : 'badge-short-term';
    const termText = lot.is_long_term ? 'Long' : 'Short';

    html += `
      <tr>
        <td>${lot.acquired_at.substring(0, 10)}</td>
        <td class="text-end">${lot.quantity.toFixed(2)}</td>
        <td class="text-end">$${lot.cost_basis_per_share.toFixed(2)}</td>
        <td class="text-end ${lotGainClass}">${lotSign}$${lot.gain_loss.toFixed(2)}</td>
        <td><span class="holding-badge ${termBadge}">${termText}</span></td>
      </tr>
    `;
  });

  html += `
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

function displayWashSaleCheck(data) {
  const container = document.getElementById('previewResults');
  container.classList.remove('d-none');

  let html = `
    <div class="tax-card">
      <h6 class="text-white mb-3">
        <i class="fas fa-search me-2"></i>Wash Sale Check: ${data.symbol}
      </h6>
  `;

  if (data.is_risky) {
    html += `
      <div class="wash-sale-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Risk Level: ${data.risk_level.toUpperCase()}</strong>
        <p class="mb-0 mt-2">${data.recommendation}</p>
      </div>
    `;

    if (data.recent_purchases && data.recent_purchases.length > 0) {
      html += `<h6 class="text-white-50 mt-3 mb-2">Recent Purchases (Last 30 Days)</h6><ul class="text-white">`;
      data.recent_purchases.forEach(p => {
        html += `<li>${p.days_ago} days ago: ${p.quantity} shares @ $${p.cost_basis.toFixed(2)}</li>`;
      });
      html += `</ul>`;
    }
  } else {
    html += `
      <div class="harvest-opportunity">
        <i class="fas fa-check-circle me-2"></i>
        <strong>No Wash Sale Risk</strong>
        <p class="mb-0 mt-2">${data.recommendation}</p>
      </div>
    `;
  }

  html += `
      <small class="text-white-50 d-block mt-3">
        Window ends: ${data.wash_sale_window_end.substring(0, 10)}
      </small>
    </div>
  `;

  container.innerHTML = html;
}

function previewSale(symbol, quantity) {
  document.getElementById('preview_symbol').value = symbol;
  document.getElementById('preview_quantity').value = quantity;
  document.getElementById('preview_price').focus();

  // Scroll to preview form
  document.getElementById('previewForm').scrollIntoView({ behavior: 'smooth' });
}

function toggleSymbolDetails(symbol) {
  const el = document.getElementById('lots_' + symbol);
  if (el) {
    el.classList.toggle('d-none');
  }
}

async function refreshPrices() {
  try {
    const response = await fetch('/api/tax/update-prices/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
    });
    const data = await response.json();
    alert(data.message);
    if (data.status === 'success') {
      location.reload();
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error refreshing prices. Please try again.');
  }
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock javascripts %}
